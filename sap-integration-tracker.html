<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Integration Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0d0f14;--surface:#161920;--surface2:#1e2230;--border:#2a2f42;
    --border-bright:#3d4560;--text:#e2e6f3;--text-muted:#7a8299;--text-dim:#4a5068;
    --accent:#4f9cf9;--accent-dim:#1a3558;--green:#3ddc84;--green-dim:#1a3d2e;
    --yellow:#f5c842;--yellow-dim:#3d3010;--red:#f96060;--red-dim:#3d1a1a;
    --purple:#a78bfa;--purple-dim:#2d1f58;--orange:#fb923c;--orange-dim:#3d2010;
    --mono:'IBM Plex Mono',monospace;--sans:'IBM Plex Sans',sans-serif;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{background:var(--bg);color:var(--text);font-family:var(--sans);font-size:14px;min-height:100vh;overflow-x:hidden;}

  /* LAYOUT */
  .app{display:flex;height:100vh;overflow:hidden;}
  .sidebar{width:240px;min-width:240px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:width .2s ease,min-width .2s ease;}
  .sidebar.collapsed{width:52px;min-width:52px;}
  .main{flex:1;display:flex;flex-direction:column;overflow:hidden;}

  /* SIDEBAR COLLAPSE TOGGLE */
  .sidebar-toggle{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:16px;padding:4px 6px;border-radius:4px;transition:all .15s;flex-shrink:0;line-height:1;}
  .sidebar-toggle:hover{color:var(--accent);background:var(--accent-dim);}
  .sidebar.collapsed .sidebar-toggle{transform:rotate(180deg);}

  /* LOGO ICON (shown only when collapsed) */
  .logo-icon{display:none;width:28px;height:28px;}
  .sidebar.collapsed .logo-icon{display:block;}
  .sidebar.collapsed .logo,.sidebar.collapsed .logo-sub{display:none;}

  /* COLLAPSED STATE ‚Äî hide text, center icons */
  .sidebar.collapsed .sidebar-header{padding:10px 0;display:flex;flex-direction:column;align-items:center;gap:6px;}
  .sidebar.collapsed .sidebar-header > div:first-child{justify-content:center;}
  .sidebar.collapsed .cu-info,.sidebar.collapsed .cu-logout,
  .sidebar.collapsed .sidebar-section-label,.sidebar.collapsed .project-name,.sidebar.collapsed .project-count,
  .sidebar.collapsed .nav-label,
  .sidebar.collapsed .nav-section-label{display:none;}
  .sidebar.collapsed #globalSearch{display:none;}
  .sidebar.collapsed #globalSearchResults{display:none!important;}
  .sidebar.collapsed .btn-add-project{display:none;}
  .sidebar.collapsed .current-user-bar{justify-content:center;padding:8px 0;}
  .sidebar.collapsed .project-list{padding:4px 0;}
  .sidebar.collapsed .project-item{justify-content:center;padding:8px 0;border-left:none;gap:0;}
  .sidebar.collapsed .project-item.active{border-left:none;background:var(--accent-dim);}
  .sidebar.collapsed .project-dot{width:10px;height:10px;cursor:pointer;}
  .sidebar.collapsed .nav-item{justify-content:center;padding:8px 0;gap:0;position:relative;}
  .sidebar.collapsed .nav-icon{font-size:16px;width:auto;}
  .sidebar.collapsed .nav-section-sep{margin:6px 8px;}
  .sidebar.collapsed .notif-dot{position:absolute;top:-2px;right:-2px;}

  /* MOBILE */
  @media (max-width:768px) {
    .sidebar{position:fixed;left:0;top:0;bottom:0;z-index:50;width:52px;min-width:52px;}
    .sidebar .logo-icon{display:block;}
    .sidebar .logo,.sidebar .logo-sub{display:none;}
    .sidebar .cu-info,.sidebar .cu-logout,
    .sidebar .sidebar-section-label,.sidebar .project-name,.sidebar .project-count,
    .sidebar .nav-label,
    .sidebar .nav-section-label{display:none;}
    .sidebar #globalSearch{display:none;}
    .sidebar #globalSearchResults{display:none!important;}
    .sidebar .btn-add-project{display:none;}
    .sidebar .current-user-bar{justify-content:center;padding:8px 0;}
    .sidebar .sidebar-header{padding:10px 0;display:flex;flex-direction:column;align-items:center;gap:6px;}
    .sidebar .sidebar-header > div:first-child{justify-content:center;}
    .sidebar .project-list{padding:4px 0;}
    .sidebar .project-item{justify-content:center;padding:8px 0;border-left:none;gap:0;}
    .sidebar .project-item.active{border-left:none;background:var(--accent-dim);}
    .sidebar .project-dot{width:10px;height:10px;}
    .sidebar .nav-item{justify-content:center;padding:8px 0;gap:0;position:relative;}
    .sidebar .nav-icon{font-size:16px;width:auto;}
    .sidebar .nav-section-sep{margin:6px 8px;}
    .sidebar .sidebar-toggle{display:none;}
    .sidebar.expanded{width:240px;min-width:240px;box-shadow:4px 0 20px rgba(0,0,0,.5);}
    .sidebar.expanded .logo{display:block;}
    .sidebar.expanded .logo-icon{display:none;}
    .sidebar.expanded .logo-sub,.sidebar.expanded .cu-info,.sidebar.expanded .cu-logout,
    .sidebar.expanded .sidebar-section-label,.sidebar.expanded .project-name,.sidebar.expanded .project-count,
    .sidebar.expanded .btn-add-project span:last-child,.sidebar.expanded .nav-label,
    .sidebar.expanded .nav-section-label{display:revert;}
    .sidebar.expanded #globalSearch{display:revert;}
    .sidebar.expanded #globalSearchResults{display:revert;}
    .sidebar.expanded .current-user-bar{justify-content:flex-start;padding:8px 14px;}
    .sidebar.expanded .sidebar-header{padding:20px 16px 14px;display:block;}
    .sidebar.expanded .project-item{justify-content:flex-start;padding:8px 16px;border-left:2px solid transparent;gap:8px;}
    .sidebar.expanded .project-item.active{border-left-color:var(--accent);}
    .sidebar.expanded .project-dot{width:7px;height:7px;}
    .sidebar.expanded .btn-add-project{display:flex;margin:8px 12px;padding:7px 12px;justify-content:flex-start;width:calc(100% - 24px);border-style:dashed;font-size:12px;}
    .sidebar.expanded .nav-item{justify-content:flex-start;padding:8px 16px;gap:8px;}
    .sidebar.expanded .nav-icon{font-size:14px;width:16px;}
    .sidebar.expanded .nav-section-sep{margin:6px 16px;}
    .main{margin-left:52px;}
    .stats-row{grid-template-columns:repeat(2,1fr)!important;}
    .topbar{flex-wrap:wrap;gap:8px;}
    .topbar-actions{flex-wrap:wrap;}
  }

  /* SIDEBAR */
  .sidebar-header{padding:20px 16px 14px;border-bottom:1px solid var(--border);}
  .logo{font-family:var(--mono);font-size:11px;font-weight:600;letter-spacing:.15em;color:var(--accent);text-transform:uppercase;margin-bottom:2px;}
  .logo-sub{font-size:11px;color:var(--text-muted);font-family:var(--mono);}
  .current-user-bar{display:flex;align-items:center;gap:8px;padding:8px 14px;background:var(--surface2);border-bottom:1px solid var(--border);font-size:12px;}
  .cu-avatar{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0;}
  .cu-info{flex:1;min-width:0;}
  .cu-name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .cu-role{font-size:10px;color:var(--text-muted);font-family:var(--mono);}
  .cu-logout{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:11px;padding:2px 4px;border-radius:3px;}
  .cu-logout:hover{color:var(--red);background:var(--red-dim);}
  .sidebar-section-label{font-family:var(--mono);font-size:10px;letter-spacing:.12em;color:var(--text-dim);text-transform:uppercase;padding:14px 16px 6px;}
  .project-list{flex:1;overflow-y:auto;padding-bottom:8px;}
  .project-item{display:flex;align-items:center;gap:8px;padding:8px 16px;cursor:pointer;transition:background .1s;border-left:2px solid transparent;font-size:13px;}
  .project-item:hover{background:var(--surface2);}
  .project-item.active{background:var(--accent-dim);border-left-color:var(--accent);color:var(--accent);}
  .project-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
  .project-name{flex:1;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .project-count{font-family:var(--mono);font-size:10px;color:var(--text-dim);}
  .btn-add-project{margin:8px 12px;padding:7px 12px;background:transparent;border:1px dashed var(--border-bright);color:var(--text-muted);border-radius:5px;cursor:pointer;font-size:12px;font-family:var(--sans);transition:all .15s;width:calc(100% - 24px);text-align:left;display:flex;align-items:center;gap:6px;}
  .btn-add-project:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim);}
  .sidebar-nav{border-top:1px solid var(--border);padding:8px 0;}
  .nav-item{display:flex;align-items:center;gap:8px;padding:8px 16px;cursor:pointer;font-size:12px;color:var(--text-muted);transition:color .1s;user-select:none;}
  .nav-item:hover{color:var(--text);}
  .nav-item.active{color:var(--accent);}
  .nav-item.locked{opacity:.3;cursor:not-allowed;}
  .nav-icon{font-size:14px;width:16px;text-align:center;}
  .nav-section-sep{height:1px;background:var(--border);margin:6px 16px;}
  .nav-section-label{font-family:var(--mono);font-size:9px;letter-spacing:.12em;color:var(--text-dim);text-transform:uppercase;padding:8px 16px 2px;}

  /* TOPBAR */
  .topbar{padding:14px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface);flex-shrink:0;z-index:10;}
  .topbar-left{display:flex;align-items:center;gap:12px;}
  .topbar-project{font-size:16px;font-weight:600;}
  .topbar-badge{font-family:var(--mono);font-size:10px;padding:2px 7px;border-radius:3px;font-weight:600;letter-spacing:.05em;}
  .topbar-actions{display:flex;gap:8px;}

  /* TABS */
  .tabs{display:flex;padding:0 24px;border-bottom:1px solid var(--border);background:var(--surface);overflow-x:auto;flex-shrink:0;z-index:9;}
  .tab{padding:11px 14px;font-size:12px;font-weight:500;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;white-space:nowrap;display:flex;align-items:center;gap:5px;font-family:var(--mono);letter-spacing:.04em;}
  .tab:hover{color:var(--text);}
  .tab.active{color:var(--accent);border-bottom-color:var(--accent);}
  .tab-badge{background:var(--surface2);padding:1px 5px;border-radius:3px;font-size:10px;}

  /* CONTENT */
  .content{padding:24px;flex:1;overflow-y:auto;}

  /* STATS */
  .stats-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:24px;}
  .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px 16px;}
  .stat-label{font-family:var(--mono);font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;}
  .stat-value{font-family:var(--mono);font-size:22px;font-weight:600;line-height:1;}
  .stat-sub{font-size:11px;color:var(--text-muted);margin-top:4px;}

  /* SECTION */
  .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
  .section-title{font-family:var(--mono);font-size:11px;font-weight:600;letter-spacing:.1em;color:var(--text-muted);text-transform:uppercase;}

  /* TABLE */
  .table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:24px;}
  table{width:100%;border-collapse:collapse;}
  thead tr{background:var(--surface2);}
  th{padding:10px 14px;text-align:left;font-family:var(--mono);font-size:10px;font-weight:600;letter-spacing:.1em;color:var(--text-dim);text-transform:uppercase;white-space:nowrap;border-bottom:1px solid var(--border);}
  td{padding:11px 14px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle;}
  tr:last-child td{border-bottom:none;}
  tbody tr:hover{background:var(--surface2);}
  .td-mono{font-family:var(--mono);font-size:12px;}
  .td-muted{color:var(--text-muted);}

  /* BADGES */
  .badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:3px;font-size:11px;font-weight:600;font-family:var(--mono);white-space:nowrap;}
  .badge-spec{background:var(--accent-dim);color:var(--accent);}
  .badge-dev{background:var(--yellow-dim);color:var(--yellow);}
  .badge-review{background:var(--purple-dim);color:var(--purple);}
  .badge-done{background:var(--green-dim);color:var(--green);}
  .badge-parked{background:var(--surface2);color:var(--text-dim);}
  .badge-blocked{background:var(--red-dim);color:var(--red);}
  .badge-high{background:var(--red-dim);color:var(--red);}
  .badge-medium{background:var(--yellow-dim);color:var(--yellow);}
  .badge-low{background:var(--green-dim);color:var(--green);}
  .badge-admin{background:var(--purple-dim);color:var(--purple);}
  .badge-architect{background:var(--accent-dim);color:var(--accent);}
  .badge-developer{background:var(--yellow-dim);color:var(--yellow);}
  .badge-viewer{background:var(--surface2);color:var(--text-muted);}
  .badge-pending{background:var(--orange-dim);color:var(--orange);}

  /* BUTTONS */
  .btn{padding:7px 14px;border-radius:5px;border:none;cursor:pointer;font-size:12px;font-family:var(--sans);font-weight:500;transition:all .15s;display:inline-flex;align-items:center;gap:6px;}
  .btn-primary{background:var(--accent);color:#fff;}
  .btn-primary:hover{background:#3a8ce8;}
  .btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border);}
  .btn-secondary:hover{border-color:var(--border-bright);}
  .btn-ghost{background:transparent;color:var(--text-muted);}
  .btn-ghost:hover{color:var(--text);background:var(--surface2);}
  .btn-danger{background:var(--red-dim);color:var(--red);border:1px solid transparent;}
  .btn-danger:hover{border-color:var(--red);}
  .btn-success{background:var(--green-dim);color:var(--green);border:1px solid transparent;}
  .btn-success:hover{border-color:var(--green);}
  .btn-edit{background:var(--accent-dim);color:var(--accent);border:1px solid transparent;}
  .btn-edit:hover{border-color:var(--accent);}
  .btn-sm{padding:4px 10px;font-size:11px;margin-left:3px;}
  .btn-sm:first-child{margin-left:0;}

  /* FILTER BAR */
  .filter-bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;}
  .filter-bar label{font-size:10px;margin-bottom:0;white-space:nowrap;}
  .filter-bar select,.filter-bar input{padding:5px 8px;font-size:12px;min-width:0;width:auto;max-width:160px;}
  .filter-bar input[type=text]{max-width:180px;}
  .filter-group{display:flex;align-items:center;gap:4px;}
  .sort-btn{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:13px;padding:2px 4px;border-radius:3px;transition:color .15s;}
  .sort-btn:hover,.sort-btn.active{color:var(--accent);}

  /* FORM */
  .form-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-bottom:16px;}
  .form-group{display:flex;flex-direction:column;gap:4px;flex:1;min-width:130px;}
  .form-group.small{flex:0 0 auto;min-width:100px;}
  label{font-size:11px;color:var(--text-muted);font-family:var(--mono);letter-spacing:.05em;}
  .req{color:var(--red);margin-left:2px;font-weight:700;}
  input,select,textarea{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px 10px;border-radius:5px;font-size:13px;font-family:var(--sans);outline:none;transition:border-color .15s;width:100%;}
  input:focus,select:focus,textarea:focus{border-color:var(--accent);}
  select option{background:var(--surface2);}
  textarea{resize:vertical;min-height:70px;}
  .checkbox-row{display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;}
  .checkbox-row input[type=checkbox]{width:auto;cursor:pointer;}

  /* MODAL */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(2px);}
  .modal-overlay.hidden{display:none;}
  .hidden{display:none!important;}
  .modal{background:var(--surface);border:1px solid var(--border-bright);border-radius:10px;width:520px;max-width:95vw;max-height:90vh;overflow-y:auto;padding:24px;}
  .modal-title{font-size:15px;font-weight:600;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;}
  .modal-close{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px;line-height:1;padding:2px;}
  .modal-close:hover{color:var(--text);}

  /* PROGRESS */
  .progress-bar{height:4px;background:var(--surface2);border-radius:2px;overflow:hidden;margin-top:4px;}
  .progress-fill{height:100%;border-radius:2px;background:var(--accent);transition:width .3s;}
  .progress-fill.green{background:var(--green);}

  /* TIME LOG */
  .time-entry{display:flex;gap:12px;align-items:flex-start;padding:10px 0;border-bottom:1px solid var(--border);font-size:12px;}
  .time-entry:last-child{border-bottom:none;}
  .time-who{width:80px;flex-shrink:0;font-family:var(--mono);font-size:11px;color:var(--accent);font-weight:600;}
  .time-hours{width:50px;flex-shrink:0;font-family:var(--mono);font-weight:600;}
  .time-desc{flex:1;color:var(--text);}
  .time-date{color:var(--text-dim);font-family:var(--mono);font-size:11px;}

  /* OPEN POINTS */
  .open-point{padding:12px 14px;border-left:3px solid var(--yellow);background:var(--yellow-dim);border-radius:0 5px 5px 0;margin-bottom:8px;font-size:13px;}
  .open-point.resolved{border-left-color:var(--green);background:var(--green-dim);opacity:.7;}
  .open-point-header{display:flex;justify-content:space-between;margin-bottom:4px;}
  .open-point-id{font-family:var(--mono);font-size:10px;color:var(--text-muted);}
  .open-point-owner{font-family:var(--mono);font-size:11px;color:var(--yellow);}
  .open-point.resolved .open-point-owner{color:var(--green);}

  /* SCROLLBAR */
  ::-webkit-scrollbar{width:5px;height:5px;}
  ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:var(--border-bright);border-radius:3px;}

  /* EMPTY STATE */
  .empty-state{text-align:center;padding:40px 20px;color:var(--text-dim);font-size:13px;}
  .empty-icon{font-size:32px;margin-bottom:8px;}

  /* COLOR PICKER */
  .color-options{display:flex;gap:8px;margin-top:4px;}
  .color-opt{width:20px;height:20px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .15s;}
  .color-opt:hover,.color-opt.selected{border-color:var(--text);transform:scale(1.1);}
  .tag{display:inline-block;padding:1px 6px;border-radius:3px;font-size:10px;font-family:var(--mono);background:var(--surface2);color:var(--text-muted);margin-right:4px;}

  /* CHECKLIST */
  .checklist-item{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);font-size:13px;}
  .checklist-item:last-child{border-bottom:none;}
  .check-box{width:16px;height:16px;border:2px solid var(--border-bright);border-radius:3px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;transition:all .15s;}
  .check-box.checked{background:var(--green);border-color:var(--green);color:#000;}

  /* RTE */
  .rte-wrap{border:1px solid var(--border);border-radius:5px;overflow:hidden;transition:border-color .15s;}
  .rte-wrap:focus-within{border-color:var(--accent);}
  .rte-toolbar{display:flex;gap:2px;padding:5px 8px;background:var(--bg);border-bottom:1px solid var(--border);flex-wrap:wrap;align-items:center;}
  .rte-btn{padding:3px 7px;background:transparent;border:none;color:var(--text-muted);cursor:pointer;border-radius:3px;font-size:12px;font-family:var(--sans);line-height:1.4;transition:all .1s;min-width:24px;text-align:center;}
  .rte-btn:hover{background:var(--surface2);color:var(--text);}
  .rte-divider{width:1px;height:16px;background:var(--border);margin:0 3px;flex-shrink:0;}
  .rte-hl{width:18px;height:18px;border-radius:3px;border:2px solid transparent;cursor:pointer;transition:transform .1s;flex-shrink:0;}
  .rte-hl:hover{transform:scale(1.15);border-color:var(--text-muted);}
  .rte-content{background:var(--surface2);color:var(--text);padding:8px 10px;min-height:80px;outline:none;font-size:13px;font-family:var(--sans);line-height:1.6;position:relative;}

  /* @mention dropdown */
  .mention-dropdown{position:fixed;background:var(--surface);border:1px solid var(--border-bright);border-radius:6px;box-shadow:0 4px 16px rgba(0,0,0,.4);z-index:500;max-height:160px;overflow-y:auto;min-width:180px;}
  .mention-item{padding:7px 12px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:8px;transition:background .1s;}
  .mention-item:hover,.mention-item.active{background:var(--accent-dim);color:var(--accent);}
  .mention-item-avatar{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;flex-shrink:0;}
  .mention-item-name{font-weight:500;}
  .mention-item-role{font-size:10px;color:var(--text-dim);font-family:var(--mono);}
  .mention-tag{background:var(--accent-dim);color:var(--accent);padding:1px 4px;border-radius:3px;font-weight:600;font-size:12px;white-space:nowrap;}

  /* Input user autocomplete (reuses mention-dropdown styles) */
  .input-autocomplete{position:fixed;background:var(--surface);border:1px solid var(--border-bright);border-radius:6px;box-shadow:0 4px 16px rgba(0,0,0,.4);z-index:500;max-height:160px;overflow-y:auto;min-width:180px;}
  .input-autocomplete.hidden{display:none;}
  .rte-content ul,.rte-content ol{padding-left:20px;}
  .rte-content:empty:before{content:attr(data-placeholder);color:var(--text-dim);pointer-events:none;}

  /* TEMPLATE CARDS */
  .template-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px;transition:border-color .15s;cursor:pointer;}
  .template-card:hover{border-color:var(--border-bright);}
  .template-card-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
  .template-code{font-family:var(--mono);font-size:13px;font-weight:600;color:var(--accent);min-width:55px;}
  .template-name{font-weight:600;flex:1;}
  .template-desc{font-size:12px;color:var(--text-muted);line-height:1.5;}
  .template-meta{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}

  /* USER MANAGEMENT */
  .user-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;gap:12px;}
  .user-card:hover{border-color:var(--border-bright);}
  .user-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;}
  .user-info{flex:1;min-width:0;}
  .user-name{font-weight:600;font-size:14px;}
  .user-email{font-size:12px;color:var(--text-muted);font-family:var(--mono);}
  .user-meta{display:flex;gap:6px;margin-top:4px;flex-wrap:wrap;}
  .user-actions{display:flex;gap:6px;}

  /* REQUEST CARD */
  .request-card{background:var(--surface);border:1px solid var(--orange);border-radius:8px;padding:14px 16px;margin-bottom:10px;}
  .request-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
  .request-info{flex:1;}
  .request-name{font-weight:600;}
  .request-email{font-size:12px;color:var(--text-muted);font-family:var(--mono);}
  .request-msg{font-size:12px;color:var(--text-muted);margin-top:6px;font-style:italic;}
  .request-date{font-size:11px;color:var(--text-dim);font-family:var(--mono);margin-top:4px;}
  .request-actions{display:flex;gap:6px;flex-shrink:0;}

  /* PERMISSIONS GRID */
  .perm-grid{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;}
  .perm-label{font-size:13px;}
  .perm-check{display:flex;justify-content:center;}
  .perm-check input{cursor:pointer;}
  .perm-header{font-family:var(--mono);font-size:10px;color:var(--text-dim);text-align:center;text-transform:uppercase;letter-spacing:.05em;}

  /* LOGIN SCREEN */
  .login-overlay{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:200;}
  .login-overlay.hidden{display:none;}
  .login-box{background:var(--surface);border:1px solid var(--border-bright);border-radius:12px;padding:36px;width:400px;max-width:95vw;}
  .login-logo{font-family:var(--mono);font-size:13px;font-weight:600;letter-spacing:.15em;color:var(--accent);text-transform:uppercase;margin-bottom:4px;}
  .login-sub{font-size:12px;color:var(--text-muted);margin-bottom:28px;}
  .login-title{font-size:18px;font-weight:600;margin-bottom:20px;}
  .login-switch{font-size:12px;color:var(--text-muted);text-align:center;margin-top:16px;}
  .login-switch a{color:var(--accent);cursor:pointer;text-decoration:none;}
  .login-switch a:hover{text-decoration:underline;}
  .login-error{background:var(--red-dim);border:1px solid var(--red);color:var(--red);padding:8px 12px;border-radius:5px;font-size:12px;margin-bottom:14px;display:none;}
  .login-success{background:var(--green-dim);border:1px solid var(--green);color:var(--green);padding:8px 12px;border-radius:5px;font-size:12px;margin-bottom:14px;display:none;}
  .login-error.visible{display:block;}
  .login-success.visible{display:block;}

  .access-denied{display:flex;align-items:center;justify-content:center;height:100%;color:var(--red);font-size:13px;gap:8px;}

  .notif-dot{width:7px;height:7px;background:var(--orange);border-radius:50%;display:inline-block;margin-left:4px;vertical-align:middle;}

  /* TOAST NOTIFICATIONS */
  .toast-container{position:fixed;top:16px;right:16px;z-index:500;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
  .toast{pointer-events:auto;padding:10px 16px;border-radius:6px;font-size:13px;font-family:var(--sans);display:flex;align-items:center;gap:8px;animation:toastIn .25s ease;min-width:220px;max-width:400px;box-shadow:0 4px 16px rgba(0,0,0,.4);}
  .toast.success{background:var(--green-dim);border:1px solid var(--green);color:var(--green);}
  .toast.error{background:var(--red-dim);border:1px solid var(--red);color:var(--red);}
  .toast.info{background:var(--accent-dim);border:1px solid var(--accent);color:var(--accent);}
  .toast.warning{background:var(--yellow-dim);border:1px solid var(--yellow);color:var(--yellow);}
  .toast.out{animation:toastOut .2s ease forwards;}
  .toast-icon{font-size:15px;flex-shrink:0;}
  @keyframes toastIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
  @keyframes toastOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(40px)}}

  /* TOP LOADING BAR */
  .loading-bar{position:fixed;top:0;left:0;height:3px;background:var(--accent);z-index:600;transition:width .3s ease;box-shadow:0 0 8px var(--accent);}
  .loading-bar.hidden{display:none;}

  /* CONFIRM DIALOG */
  .confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:400;backdrop-filter:blur(2px);}
  .confirm-overlay.hidden{display:none;}
  .confirm-box{background:var(--surface);border:1px solid var(--border-bright);border-radius:10px;padding:24px;width:400px;max-width:90vw;}
  .confirm-msg{font-size:14px;margin-bottom:20px;line-height:1.5;}
  .confirm-actions{display:flex;gap:8px;justify-content:flex-end;}
  /* ‚ïê‚ïê‚ïê UX ENHANCEMENTS ‚ïê‚ïê‚ïê */

  /* 1. Smooth View Transitions */
  [id^="view-"]{opacity:0;transform:translateY(8px);transition:opacity 180ms ease,transform 180ms ease;pointer-events:none;}
  [id^="view-"].view-active{opacity:1;transform:translateY(0);pointer-events:auto;}

  /* 2. Button Micro-Interactions */
  .btn{transition:all .15s ease;}
  .btn:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.25);}
  .btn:active{transform:translateY(0);box-shadow:0 1px 2px rgba(0,0,0,.15);}
  .btn-sm:hover{transform:translateY(-1px);box-shadow:0 2px 6px rgba(0,0,0,.2);}
  .btn-sm:active{transform:translateY(0);}

  /* 3. Sidebar Animation Enhancement */
  .sidebar{transition:width .25s ease,min-width .25s ease,transform .25s ease;}

  /* 4. Smooth Modal Animation */
  .modal-overlay{opacity:0;transition:opacity 180ms ease;}
  .modal-overlay.modal-visible{opacity:1;}
  .modal-overlay .modal,.modal-overlay .confirm-box{transform:scale(.95);transition:transform 180ms ease;}
  .modal-overlay.modal-visible .modal,.modal-overlay.modal-visible .confirm-box{transform:scale(1);}

  /* 6. Status Badge Pulse */
  @keyframes badgePulse{0%{transform:scale(1)}50%{transform:scale(1.12)}100%{transform:scale(1)}}
  .badge-pulse{animation:badgePulse 200ms ease;}

  /* 7. Table Row Hover */
  tbody tr{transition:background .12s ease,transform .12s ease;}
  tbody tr:hover{transform:translateX(2px);}

  /* 8. Input Focus Glow */
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(79,156,249,.2);outline:none;transition:border-color .15s ease,box-shadow .15s ease;}

  /* 10. Counter Animation */
  @keyframes countFadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  .stat-value{animation:countFadeIn .3s ease;}

  /* Sortable Column Headers */
  th.sortable{cursor:pointer;user-select:none;position:relative;padding-right:20px;transition:color .15s;}
  th.sortable:hover{color:var(--accent);}
  th.sortable::after{content:'‚áÖ';position:absolute;right:4px;top:50%;transform:translateY(-50%);font-size:10px;color:var(--text-dim);transition:color .15s;}
  th.sortable.sort-asc::after{content:'‚ñ≤';color:var(--accent);}
  th.sortable.sort-desc::after{content:'‚ñº';color:var(--accent);}
  th.sortable.sort-asc,th.sortable.sort-desc{color:var(--accent);}

  /* Bulk action bar */
  .bulk-bar{display:none;align-items:center;gap:10px;padding:8px 14px;background:var(--accent-dim);border:1px solid var(--accent);border-radius:6px;margin-bottom:10px;font-size:12px;}
  .bulk-count{font-family:var(--mono);font-weight:600;color:var(--accent);}
  .bulk-check{width:14px;height:14px;cursor:pointer;accent-color:var(--accent);}
  tr[draggable=true]{cursor:grab;}
  tr[draggable=true]:active{cursor:grabbing;}

  /* Card / Table wrap entrance */
  .table-wrap,.stat-card,.template-card,.user-card,.request-card,.open-point{transition:border-color .15s ease,box-shadow .15s ease;}
  .table-wrap:hover,.stat-card:hover{box-shadow:0 2px 12px rgba(0,0,0,.15);}
  .template-card:hover,.user-card:hover{box-shadow:0 2px 10px rgba(0,0,0,.15);}

  /* Confirm dialog animation (reuse modal pattern) */
  .confirm-overlay{opacity:0;transition:opacity 180ms ease;}
  .confirm-overlay.confirm-visible{opacity:1;}
  .confirm-overlay .confirm-box{transform:scale(.95);transition:transform 180ms ease;}
  .confirm-overlay.confirm-visible .confirm-box{transform:scale(1);}
</style>
</head>
<body>

<!-- TOAST NOTIFICATIONS -->
<div class="toast-container" id="toastContainer"></div>

<!-- @MENTION DROPDOWN -->
<div class="mention-dropdown hidden" id="mentionDropdown"></div>

<!-- INPUT USER AUTOCOMPLETE -->
<div class="input-autocomplete hidden" id="inputAutocomplete"></div>

<!-- TOP LOADING BAR -->
<div class="loading-bar hidden" id="loadingBar" style="width:0%"></div>

<!-- CONFIRM DIALOG -->
<div class="confirm-overlay hidden" id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-msg" id="confirmMsg"></div>
    <div class="confirm-actions">
      <button class="btn btn-secondary" onclick="confirmResolve(false)">Cancel</button>
      <button class="btn btn-danger" id="confirmBtn" onclick="confirmResolve(true)">Delete</button>
    </div>
  </div>
</div>

<!-- LOGIN / REQUEST ACCESS OVERLAY -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <div class="login-logo">Integration Tracker</div>
    <div class="login-sub">Integration Dev Portal ¬∑ delaware</div>

    <!-- LOGIN FORM -->
    <div id="loginForm">
      <div class="login-title">Sign in</div>
      <div class="login-error" id="loginError"></div>
      <div class="form-group" style="margin-bottom:12px">
        <label>Email<span class="req">*</span></label>
        <input id="login-email" type="email" placeholder="cedric.baert@delaware.pro" onkeydown="if(event.key==='Enter')doLogin()" />
      </div>
      <div class="form-group" style="margin-bottom:20px">
        <label>Password<span class="req">*</span></label>
        <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()" />
      </div>
      <button class="btn btn-primary" style="width:100%" onclick="doLogin()">Sign In</button>
      <div class="login-switch">No access yet? <a onclick="showRequestForm()">Request access</a></div>
    </div>

    <!-- REQUEST ACCESS FORM -->
    <div id="requestForm" class="hidden">
      <div class="login-title">Request Access</div>
      <div class="login-error" id="requestError"></div>
      <div class="login-success" id="requestSuccess"></div>
      <div class="form-group" style="margin-bottom:12px">
        <label>Full Name<span class="req">*</span></label>
        <input id="req-name" placeholder="Your full name" />
      </div>
      <div class="form-group" style="margin-bottom:12px">
        <label>Email<span class="req">*</span></label>
        <input id="req-email" type="email" placeholder="your.email@company.com" />
      </div>
      <div class="form-group" style="margin-bottom:20px">
        <label>What access do you need?</label>
        <textarea id="req-reason" placeholder="e.g. I'm assigned as developer on the integration project and need access to log time and view interfaces." style="min-height:80px"></textarea>
      </div>
      <button class="btn btn-primary" style="width:100%" onclick="submitAccessRequest()">Submit Request</button>
      <div class="login-switch"><a onclick="showLoginForm()">‚Üê Back to sign in</a></div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div class="app" id="mainApp">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <!-- Full text logo (visible when expanded) -->
        <div class="logo">Integration Tracker</div>
        <!-- Icon logo (visible when collapsed) -->
        <svg class="logo-icon" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="1" y="1" width="26" height="26" rx="6" stroke="#4f9cf9" stroke-width="1.5" fill="#1a3558"/>
          <path d="M8 9h4v10H8z" fill="#4f9cf9" opacity=".9"/>
          <path d="M16 9h4v10h-4z" fill="#4f9cf9" opacity=".5"/>
          <path d="M12 12h4v2h-4z" fill="#4f9cf9" opacity=".7"/>
          <path d="M12 16h4v2h-4z" fill="#4f9cf9" opacity=".7"/>
        </svg>
        <button class="sidebar-toggle" onclick="toggleSidebar()" title="Collapse sidebar">‚óÄ</button>
      </div>
      <div class="logo-sub">Integration Dev Portal</div>
    </div>
    <div class="current-user-bar" id="currentUserBar">
      <div class="cu-avatar" id="cuAvatar" style="background:var(--accent-dim);color:var(--accent)">?</div>
      <div class="cu-info">
        <div class="cu-name" id="cuName">‚Äî</div>
        <div class="cu-role" id="cuRole">‚Äî</div>
      </div>
      <button class="cu-logout" onclick="doLogout()" title="Sign out">‚Ü©</button>
    </div>

    <div class="sidebar-section-label">Projects</div>
    <div class="project-list" id="projectList"></div>
    <button class="btn-add-project" id="btnAddProject" onclick="openModal('addProject')">
      <span>Ôºã</span> New Project
    </button>

    <div style="padding:6px 12px;border-top:1px solid var(--border)">
      <input type="text" id="globalSearch" placeholder="Search all..." oninput="doGlobalSearch(this.value)" style="width:100%;padding:5px 8px;font-size:11px"/>
    </div>
    <div id="globalSearchResults" class="hidden" style="max-height:200px;overflow-y:auto;padding:0 8px 8px;font-size:11px"></div>
    <nav class="sidebar-nav" id="sideNav">
      <div class="nav-item active" onclick="navClick('dashboard')" id="nav-dashboard"><span class="nav-icon">‚óà</span><span class="nav-label"> Dashboard</span></div>
      <div class="nav-item" onclick="navClick('interfaces')" id="nav-interfaces"><span class="nav-icon">‚áÑ</span><span class="nav-label"> Interfaces</span></div>
      <div class="nav-item" onclick="navClick('timelog')" id="nav-timelog"><span class="nav-icon">‚ó∑</span><span class="nav-label"> Time Log</span></div>
      <div class="nav-item" onclick="navClick('openpoints')" id="nav-openpoints"><span class="nav-icon">‚óé</span><span class="nav-label"> Open Points</span></div>
      <div class="nav-item" onclick="navClick('validation')" id="nav-validation"><span class="nav-icon">‚úì</span><span class="nav-label"> Validation</span></div>
      <div class="nav-section-sep"></div>
      <div class="nav-section-label">Admin</div>
      <div class="nav-item" onclick="navClick('templates')" id="nav-templates"><span class="nav-icon">‚äû</span><span class="nav-label"> dIF Templates</span></div>
      <div class="nav-item" onclick="navClick('users')" id="nav-users"><span class="nav-icon">‚äô</span><span class="nav-label"> Users</span> <span id="nav-req-dot" class="hidden"></span></div>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div class="topbar-left">
        <span class="topbar-project" id="topbarProject">Select a project</span>
        <span class="topbar-badge badge" id="topbarBadge" style="display:none"></span>
      </div>
      <div class="topbar-actions" id="topbarActions">
        <button class="btn btn-secondary btn-sm" id="btn-addInterface" onclick="openModal('addInterface')">Ôºã Interface</button>
        <button class="btn btn-secondary btn-sm" id="btn-logTime" onclick="openModal('logTime')">Ôºã Log Time</button>
        <button class="btn btn-secondary btn-sm" id="btn-addOpenPoint" onclick="openModal('addOpenPoint')">Ôºã Open Point</button>
        <button class="btn btn-ghost btn-sm" onclick="exportProjectSummary()" title="Export project summary">‚Üì Summary</button>
        <button class="btn btn-edit btn-sm" id="btn-editProject" onclick="editProject()" title="Edit project">‚úé Project</button>
        <button class="btn btn-danger btn-sm" id="btn-deleteProject" onclick="deleteProject()" title="Delete this project">üóë Project</button>
      </div>
    </div>

    <div class="tabs" id="tabBar">
      <div class="tab active" onclick="navClick('dashboard')" id="tab-dashboard">‚óà Overview</div>
      <div class="tab" onclick="navClick('interfaces')" id="tab-interfaces">‚áÑ Interfaces <span class="tab-badge" id="tab-if-count">0</span></div>
      <div class="tab" onclick="navClick('timelog')" id="tab-timelog">‚ó∑ Time Log</div>
      <div class="tab" onclick="navClick('openpoints')" id="tab-openpoints">‚óé Open Points <span class="tab-badge" id="tab-op-count">0</span></div>
      <div class="tab" onclick="navClick('validation')" id="tab-validation">‚úì Validation</div>
    </div>

    <div class="content">
      <!-- DASHBOARD -->
      <div id="view-dashboard">
        <div class="stats-row" id="statsRow"></div>
        <div id="dashChart" style="margin-bottom:20px"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div>
            <div class="section-header"><span class="section-title">Interface Status</span></div>
            <div class="table-wrap" id="dashIfTable"></div>
          </div>
          <div>
            <div class="section-header"><span class="section-title">Recent Time Entries</span></div>
            <div class="table-wrap" style="padding:4px 14px" id="recentTime"></div>
            <div class="section-header" style="margin-top:20px"><span class="section-title">Open Points</span></div>
            <div id="dashOpenPoints"></div>
          </div>
        </div>
      </div>

      <!-- INTERFACES -->
      <div id="view-interfaces" style="display:none">
        <div class="section-header">
          <span class="section-title">All Interfaces</span>
          <div style="display:flex;gap:6px">
            <button class="btn btn-ghost btn-sm" onclick="downloadIfTemplate()" title="Download Excel import template">‚Üì Template</button>
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('ifImportFile').click()" title="Import interfaces from Excel">‚Üë Import</button>
            <input type="file" id="ifImportFile" accept=".csv,.xlsx,.xls" style="display:none" onchange="importInterfaces(this)"/>
            <button class="btn btn-primary btn-sm" id="ifAddBtn" onclick="openModal('addInterface')">Ôºã Add Interface</button>
          </div>
        </div>
        <div class="filter-bar">
          <div class="filter-group"><label>Status</label><select id="flt-if-status" onchange="renderInterfaces()"><option value="">All</option><option value="spec">Spec</option><option value="dev">Dev</option><option value="review">Review</option><option value="done">Done</option><option value="parked">Parked</option><option value="blocked">Blocked</option></select></div>
          <div class="filter-group"><label>Priority</label><select id="flt-if-priority" onchange="renderInterfaces()"><option value="">All</option><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select></div>
          <div class="filter-group"><label>Search</label><input type="text" id="flt-if-search" placeholder="Name, ID..." oninput="renderInterfaces()"/></div>
        </div>
        <div class="bulk-bar" id="bulkBar-interfaces"><span class="bulk-count">0 selected</span><button class="btn btn-danger btn-sm" onclick="bulkDelete('interfaces')">Delete selected</button></div>
        <div class="table-wrap">
          <table><thead><tr>
            <th style="width:30px"><input type="checkbox" class="bulk-check" onchange="toggleBulkAll('interfaces')"/></th><th class="sortable" onclick="colSort('if','id')">ID</th><th class="sortable" onclick="colSort('if','name')">Name</th><th class="sortable" onclick="colSort('if','source')">Source</th><th class="sortable" onclick="colSort('if','target')">Target</th><th>dIF Template</th>
            <th class="sortable" onclick="colSort('if','status')">Status</th><th class="sortable" onclick="colSort('if','priority')">Priority</th><th>Spec Author</th><th>Developer</th><th class="sortable" onclick="colSort('if','hours')">Hours</th><th>Actions</th>
          </tr></thead><tbody id="ifTableBody"></tbody></table>
        </div>
      </div>

      <!-- TIME LOG -->
      <div id="view-timelog" style="display:none">
        <div class="section-header">
          <span class="section-title">Time Log</span>
          <div style="display:flex;gap:6px">
            <button class="btn btn-ghost btn-sm" onclick="downloadTLTemplate()" title="Download Excel import template">‚Üì Template</button>
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('tlImportFile').click()" title="Import time entries from Excel">‚Üë Import</button>
            <input type="file" id="tlImportFile" accept=".csv,.xlsx,.xls" style="display:none" onchange="importTimeLogs(this)"/>
            <button class="btn btn-secondary btn-sm" onclick="exportTimeLog()" title="Export filtered time entries to Excel">‚Üì Export Excel</button>
            <button class="btn btn-primary btn-sm" onclick="openModal('logTime')">Ôºã Log Time</button>
          </div>
        </div>
        <div class="stats-row" style="grid-template-columns:repeat(4,1fr)" id="timeStats"></div>
        <div class="filter-bar">
          <div class="filter-group"><label>Person</label><select id="flt-tl-person" onchange="renderTimeLog()"><option value="">All</option></select></div>
          <div class="filter-group"><label>Role</label><select id="flt-tl-role" onchange="renderTimeLog()"><option value="">All</option><option>Architect</option><option>Developer</option><option>Testing</option></select></div>
          <div class="filter-group"><label>Phase</label><select id="flt-tl-phase" onchange="renderTimeLog()"><option value="">All</option><option>Spec Writing</option><option>Development</option><option>Integration Test</option><option>Review</option><option>Fix / Rework</option><option>Other</option></select></div>
          <div class="filter-group"><label>Interface</label><select id="flt-tl-iface" onchange="renderTimeLog()"><option value="">All</option></select></div>
        </div>
        <div class="table-wrap">
          <div class="bulk-bar" id="bulkBar-timeLogs"><span class="bulk-count">0 selected</span><button class="btn btn-danger btn-sm" onclick="bulkDelete('timeLogs')">Delete selected</button></div>
        <table><thead><tr><th style="width:30px"><input type="checkbox" class="bulk-check" onchange="toggleBulkAll('timeLogs')"/></th><th class="sortable" onclick="colSort('tl','date')">Date</th><th class="sortable" onclick="colSort('tl','person')">Person</th><th class="sortable" onclick="colSort('tl','role')">Role</th><th>Interface</th><th class="sortable" onclick="colSort('tl','phase')">Phase</th><th class="sortable" onclick="colSort('tl','hours')">Hours</th><th>Description</th><th></th></tr></thead>
          <tbody id="timeTableBody"></tbody></table>
        </div>
      </div>

      <!-- OPEN POINTS -->
      <div id="view-openpoints" style="display:none">
        <div class="section-header">
          <span class="section-title">Open Points &amp; Decisions</span>
          <div style="display:flex;gap:6px">
            <button class="btn btn-ghost btn-sm" onclick="downloadOPTemplate()" title="Download Excel import template">‚Üì Template</button>
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('opImportFile').click()" title="Import open points from Excel">‚Üë Import</button>
            <input type="file" id="opImportFile" accept=".csv,.xlsx,.xls" style="display:none" onchange="importOpenPoints(this)"/>
            <button class="btn btn-primary btn-sm" onclick="openModal('addOpenPoint')">Ôºã Add</button>
          </div>
        </div>
        <div class="filter-bar">
          <div class="filter-group"><label>Status</label><select id="flt-op-status" onchange="renderOpenPoints()"><option value="">All</option><option value="open">Open</option><option value="resolved">Resolved</option></select></div>
          <div class="filter-group"><label>Priority</label><select id="flt-op-priority" onchange="renderOpenPoints()"><option value="">All</option><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select></div>
          <div class="filter-group"><label>Owner</label><select id="flt-op-owner" onchange="renderOpenPoints()"><option value="">All</option></select></div>
          <div class="filter-group"><label>Interface</label><select id="flt-op-iface" onchange="renderOpenPoints()"><option value="">All</option></select></div>
        </div>
        <div id="opList"></div>
      </div>

      <!-- VALIDATION -->
      <div id="view-validation" style="display:none">
        <div class="section-header">
          <span class="section-title">Validation Checklists</span>
        </div>
        <div class="filter-bar">
          <div class="filter-group"><label>Status</label><select id="flt-val-status" onchange="renderValidation()"><option value="">All</option><option value="incomplete">Incomplete</option><option value="complete">Complete</option></select></div>
          <div class="filter-group"><label>Search</label><input type="text" id="flt-val-search" placeholder="Interface name..." oninput="renderValidation()"/></div>
        </div>
        <div id="validationContent"></div>
      </div>

      <!-- dIF TEMPLATES (admin only) -->
      <div id="view-templates" style="display:none">
        <div class="section-header">
          <span class="section-title">Template Library</span>
          <button class="btn btn-primary btn-sm" onclick="openAddTemplate()">Ôºã Add Template</button>
        </div>
        <div id="templateList"></div>
      </div>

      <!-- USERS (admin only) -->
      <div id="view-users" style="display:none">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:0">
          <!-- Left: Access Requests -->
          <div>
            <div class="section-header">
              <span class="section-title">Access Requests <span id="reqCount" class="tab-badge">0</span></span>
            </div>
            <div id="requestList"></div>
          </div>
          <!-- Right: Active Users -->
          <div>
            <div class="section-header">
              <span class="section-title">Active Users</span>
              <button class="btn btn-primary btn-sm" onclick="openAddUser()">Ôºã Add User</button>
            </div>
            <div id="userList"></div>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </main>
</div>

<!-- ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê -->

<!-- Add Project -->
<div class="modal-overlay hidden" id="modal-addProject">
  <div class="modal">
    <div class="modal-title">New Project <button class="modal-close" onclick="closeModal('addProject')">√ó</button></div>
    <div class="form-row">
      <div class="form-group"><label>Customer Name<span class="req">*</span></label><input id="proj-name" placeholder="e.g. Turbo's Hoet"/></div>
      <div class="form-group small"><label>Code</label><input id="proj-code" placeholder="THT" maxlength="5"/></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Description</label><input id="proj-desc" placeholder="S/4HANA Public Cloud migration"/></div></div>
    <div class="form-row">
      <div class="form-group"><label>System Landscape</label><select id="proj-landscape"><option>S/4HANA Public Cloud</option><option>S/4HANA Private Cloud</option><option>S/4HANA On-Premise</option><option>ECC On-Premise</option></select></div>
      <div class="form-group"><label>Phase</label><select id="proj-phase"><option>Discovery</option><option>Design</option><option>Build</option><option>Test</option><option>Go-Live</option></select></div>
    </div>
    <div style="margin-bottom:12px">
      <label>Color</label>
      <div class="color-options" id="colorPicker">
        <div class="color-opt selected" data-color="#4f9cf9" style="background:#4f9cf9"></div>
        <div class="color-opt" data-color="#3ddc84" style="background:#3ddc84"></div>
        <div class="color-opt" data-color="#f5c842" style="background:#f5c842"></div>
        <div class="color-opt" data-color="#f96060" style="background:#f96060"></div>
        <div class="color-opt" data-color="#a78bfa" style="background:#a78bfa"></div>
        <div class="color-opt" data-color="#fb923c" style="background:#fb923c"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('addProject')">Cancel</button>
      <button class="btn btn-primary" onclick="saveProject()">Create Project</button>
    </div>
  </div>
</div>

<!-- Add Interface -->
<div class="modal-overlay hidden" id="modal-addInterface">
  <div class="modal">
    <div class="modal-title">Add Interface <button class="modal-close" onclick="closeModal('addInterface')">√ó</button></div>
    <div class="form-row">
      <div class="form-group small"><label>Interface ID<span class="req">*</span></label><input id="if-id" placeholder="CP011-IF001"/></div>
      <div class="form-group"><label>Interface Name<span class="req">*</span></label><input id="if-name" placeholder="BTS to SAP Stock List"/></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Source System<span class="req">*</span></label><input id="if-source" placeholder="BTS"/></div>
      <div class="form-group"><label>Target System<span class="req">*</span></label><input id="if-target" placeholder="SAP S/4HANA"/></div>
    </div>
    <div class="form-row">
      <div class="form-group small"><label>dIF Template</label><select id="if-dif"></select></div>
      <div class="form-group small"><label>Status</label><select id="if-status"><option value="spec">Spec</option><option value="dev">Dev</option><option value="review">Review</option><option value="done">Done</option><option value="parked">Parked</option><option value="blocked">Blocked</option></select></div>
      <div class="form-group small"><label>Priority</label><select id="if-priority"><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Spec Author (Architect)</label><input id="if-spec-author" placeholder="Type @ to mention..." data-user-autocomplete="true"/></div>
      <div class="form-group"><label>Developer Assigned</label><input id="if-dev" placeholder="Type @ to mention..." data-user-autocomplete="true"/></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Notes / Description</label>
      <div class="rte-wrap"><div class="rte-toolbar">
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('bold')"><b>B</b></button>
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('italic')"><i>I</i></button>
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('underline')"><u>U</u></button>
        <div class="rte-divider"></div>
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('insertUnorderedList')">‚Ä¢ List</button>
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('insertOrderedList')">1. List</button>
        <div class="rte-divider"></div>
        <div class="rte-hl" style="background:#f5c842" onmousedown="event.preventDefault();applyHL('#f5c842')"></div>
        <div class="rte-hl" style="background:#f96060" onmousedown="event.preventDefault();applyHL('#f96060')"></div>
        <div class="rte-hl" style="background:#3ddc84" onmousedown="event.preventDefault();applyHL('#3ddc84')"></div>
        <div class="rte-hl" style="background:#4f9cf9" onmousedown="event.preventDefault();applyHL('#4f9cf9')"></div>
        <div class="rte-hl" style="background:var(--surface2);border:1px solid var(--border-bright);font-size:9px;display:flex;align-items:center;justify-content:center" onmousedown="event.preventDefault();removeHL()" title="Remove highlight">‚úï</div>
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('removeFormat')">‚úïfmt</button>
      </div><div class="rte-content" id="if-notes-rte" contenteditable="true" data-placeholder="Description or notes..."></div></div>
    </div></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('addInterface')">Cancel</button>
      <button class="btn btn-primary" onclick="saveInterface()">Save Interface</button>
    </div>
  </div>
</div>

<!-- Log Time -->
<div class="modal-overlay hidden" id="modal-logTime">
  <div class="modal">
    <div class="modal-title">Log Time <button class="modal-close" onclick="closeModal('logTime')">√ó</button></div>
    <div class="form-row">
      <div class="form-group"><label>Person</label><input id="tl-person" readonly style="opacity:.7;cursor:not-allowed"/></div>
      <div class="form-group small"><label>Role</label><select id="tl-role"><option>Architect</option><option>Developer</option><option>Testing</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Interface<span class="req">*</span></label><select id="tl-interface"></select></div>
      <div class="form-group small"><label>Phase</label><select id="tl-phase"><option>Spec Writing</option><option>Development</option><option>Integration Test</option><option>Review</option><option>Fix / Rework</option><option>Other</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group small"><label>Date<span class="req">*</span></label><input type="date" id="tl-date"/></div>
      <div class="form-group small"><label>Hours<span class="req">*</span></label><input type="number" id="tl-hours" min="0.25" max="24" step="0.25" placeholder="1.5"/></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Description</label>
      <div class="rte-wrap"><div class="rte-toolbar">
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('bold')"><b>B</b></button>
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('italic')"><i>I</i></button>
        <div class="rte-divider"></div>
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('insertUnorderedList')">‚Ä¢ List</button>
        <div class="rte-divider"></div>
        <div class="rte-hl" style="background:#f5c842" onmousedown="event.preventDefault();applyHL('#f5c842')"></div>
        <div class="rte-hl" style="background:#f96060" onmousedown="event.preventDefault();applyHL('#f96060')"></div>
        <div class="rte-hl" style="background:#3ddc84" onmousedown="event.preventDefault();applyHL('#3ddc84')"></div>
        <div class="rte-hl" style="background:var(--surface2);border:1px solid var(--border-bright);font-size:9px;display:flex;align-items:center;justify-content:center" onmousedown="event.preventDefault();removeHL()" title="Remove highlight">‚úï</div>
      </div><div class="rte-content" id="tl-desc-rte" contenteditable="true" data-placeholder="What was done..." style="min-height:55px"></div></div>
    </div></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('logTime')">Cancel</button>
      <button class="btn btn-primary" onclick="saveTimeEntry()">Log Time</button>
    </div>
  </div>
</div>

<!-- Add Open Point -->
<div class="modal-overlay hidden" id="modal-addOpenPoint">
  <div class="modal">
    <div class="modal-title">Add Open Point <button class="modal-close" onclick="closeModal('addOpenPoint')">√ó</button></div>
    <div class="form-row">
      <div class="form-group"><label>Interface<span class="req">*</span></label><select id="op-interface"><option value="">‚Äî Select interface ‚Äî</option></select></div>
      <div class="form-group small"><label>Priority</label><select id="op-priority"><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Description / Question<span class="req">*</span></label>
      <div class="rte-wrap"><div class="rte-toolbar">
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('bold')"><b>B</b></button>
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('italic')"><i>I</i></button>
        <div class="rte-divider"></div>
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('insertUnorderedList')">‚Ä¢ List</button>
        <div class="rte-divider"></div>
        <div class="rte-hl" style="background:#f5c842" onmousedown="event.preventDefault();applyHL('#f5c842')"></div>
        <div class="rte-hl" style="background:#f96060" onmousedown="event.preventDefault();applyHL('#f96060')"></div>
        <div class="rte-hl" style="background:#3ddc84" onmousedown="event.preventDefault();applyHL('#3ddc84')"></div>
        <div class="rte-hl" style="background:var(--surface2);border:1px solid var(--border-bright);font-size:9px;display:flex;align-items:center;justify-content:center" onmousedown="event.preventDefault();removeHL()" title="Remove highlight">‚úï</div>
      </div><div class="rte-content" id="op-desc-rte" contenteditable="true" data-placeholder="What needs to be decided or clarified?"></div></div>
    </div></div>
    <div class="form-row">
      <div class="form-group"><label>Owner</label><input id="op-owner" placeholder="Type @ to mention..." data-user-autocomplete="true"/></div>
      <div class="form-group small"><label>Due Date</label><input type="date" id="op-due"/></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('addOpenPoint')">Cancel</button>
      <button class="btn btn-primary" onclick="saveOpenPoint()">Save Open Point</button>
    </div>
  </div>
</div>

<!-- Add/Edit Template -->
<div class="modal-overlay hidden" id="modal-addTemplate">
  <div class="modal" style="width:580px">
    <div class="modal-title">Template &nbsp;<span id="tmpl-modal-id-display" style="font-family:var(--mono);color:var(--accent);font-size:13px"></span><button class="modal-close" onclick="closeModal('addTemplate')">√ó</button></div>
    <div class="form-row">
      <div class="form-group small"><label>Code<span class="req">*</span></label><input id="tmpl-code" placeholder="TF001" maxlength="10"/></div>
      <div class="form-group"><label>Name<span class="req">*</span></label><input id="tmpl-name" placeholder="Async One-Way"/></div>
      <div class="form-group small"><label>Version</label><input id="tmpl-ver" placeholder="1.5.2"/></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Short Description</label><input id="tmpl-short" placeholder="Asynchronous one-way message processing..."/></div></div>
    <div class="form-row"><div class="form-group"><label>Full Description / When to use</label>
      <div class="rte-wrap"><div class="rte-toolbar">
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('bold')"><b>B</b></button>
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('italic')"><i>I</i></button>
        <div class="rte-divider"></div>
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('insertUnorderedList')">‚Ä¢ List</button>
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('insertOrderedList')">1. List</button>
        <div class="rte-divider"></div>
        <div class="rte-hl" style="background:#f5c842" onmousedown="event.preventDefault();applyHL('#f5c842')"></div>
        <div class="rte-hl" style="background:#f96060" onmousedown="event.preventDefault();applyHL('#f96060')"></div>
        <div class="rte-hl" style="background:#3ddc84" onmousedown="event.preventDefault();applyHL('#3ddc84')"></div>
        <div class="rte-hl" style="background:#4f9cf9" onmousedown="event.preventDefault();applyHL('#4f9cf9')"></div>
        <div class="rte-hl" style="background:var(--surface2);border:1px solid var(--border-bright);font-size:9px;display:flex;align-items:center;justify-content:center" onmousedown="event.preventDefault();removeHL()" title="Remove highlight">‚úï</div>
        <button class="rte-btn" onmousedown="event.preventDefault();document.execCommand('removeFormat')">‚úïfmt</button>
      </div><div class="rte-content" id="tmpl-desc-rte" contenteditable="true" data-placeholder="Describe when to use this template..."></div></div>
    </div></div>
    <div class="form-row">
      <div class="form-group small"><label>Direction</label><select id="tmpl-dir"><option>One-Way</option><option>Request-Reply</option><option>Bidirectional</option></select></div>
      <div class="form-group small"><label>Processing</label><select id="tmpl-proc"><option>Async</option><option>Sync</option><option>Batch</option><option>Event-Driven</option></select></div>
      <div class="form-group small"><label>Protocol</label><input id="tmpl-proto" placeholder="HTTPS / AMQP"/></div>
    </div>
    <input type="hidden" id="tmpl-edit-id" value=""/>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('addTemplate')">Cancel</button>
      <button class="btn btn-danger btn-sm" id="tmpl-delete-btn" onclick="deleteTemplate()" style="display:none">Delete</button>
      <button class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
    </div>
  </div>
</div>

<!-- Add/Edit User -->
<div class="modal-overlay hidden" id="modal-addUser">
  <div class="modal" style="width:560px">
    <div class="modal-title"><span id="userModalTitle">Add User</span><button class="modal-close" onclick="closeModal('addUser')">√ó</button></div>
    <div class="form-row">
      <div class="form-group"><label>Full Name<span class="req">*</span></label><input id="u-name" placeholder="C√©dric Baert"/></div>
      <div class="form-group"><label>Email<span class="req">*</span></label><input id="u-email" type="email" placeholder="cedric.baert@delaware.pro"/></div>
    </div>
    <div class="form-row" style="align-items:flex-end">
      <div class="form-group">
        <label>Password<span class="req">*</span></label>
        <div style="display:flex;gap:6px">
          <input id="u-password" type="password" placeholder="Set a password" style="flex:1"/>
          <button type="button" class="btn btn-secondary btn-sm" onclick="togglePwVisibility('u-password','u-pw-eye')" id="u-pw-eye" title="Show/hide password" style="flex-shrink:0;padding:7px 10px">üëÅ</button>
          <button type="button" class="btn btn-secondary btn-sm" onclick="generatePassword()" title="Generate password" style="flex-shrink:0;padding:7px 10px">‚ü≥</button>
        </div>
        <div id="u-pw-hint" style="font-size:11px;color:var(--text-dim);margin-top:4px;font-family:var(--mono);display:none"></div>
      </div>
      <div class="form-group small"><label>Role</label>
        <select id="u-role" onchange="updatePermCheckboxes()">
          <option value="admin">Admin</option>
          <option value="architect">Architect</option>
          <option value="developer">Developer</option>
          <option value="viewer">Viewer</option>
          <option value="custom">Custom</option>
        </select>
      </div>
    </div>
    <div style="margin-bottom:16px">
      <label style="margin-bottom:8px;display:block">Permissions</label>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:12px">
        <div class="perm-grid" style="margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)">
          <span class="perm-header">View</span><span class="perm-header" style="grid-column:2">Read</span><span class="perm-header" style="grid-column:3">Write</span>
        </div>
        <div id="permGrid"></div>
      </div>
    </div>
    <input type="hidden" id="u-edit-id" value=""/>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('addUser')">Cancel</button>
      <button class="btn btn-danger btn-sm" id="u-delete-btn" onclick="deleteUser()" style="display:none">Remove User</button>
      <button class="btn btn-primary" onclick="saveUser()">Save User</button>
    </div>
  </div>
</div>

<!-- Approve Request -->
<div class="modal-overlay hidden" id="modal-approveRequest">
  <div class="modal">
    <div class="modal-title">Approve Access Request<button class="modal-close" onclick="closeModal('approveRequest')">√ó</button></div>
    <div id="approveRequestInfo" style="background:var(--surface2);border-radius:6px;padding:12px;margin-bottom:16px;font-size:13px;"></div>
    <div class="form-row">
      <div class="form-group"><label>Password for this user<span class="req">*</span></label><input id="ar-password" type="password" placeholder="Set initial password"/></div>
      <div class="form-group small"><label>Role</label>
        <select id="ar-role" onchange="updateARPermCheckboxes()">
          <option value="admin">Admin</option>
          <option value="architect">Architect</option>
          <option value="developer">Developer</option>
          <option value="viewer">Viewer</option>
          <option value="custom">Custom</option>
        </select>
      </div>
    </div>
    <div style="margin-bottom:16px">
      <label style="margin-bottom:8px;display:block">Permissions</label>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:12px">
        <div id="arPermGrid"></div>
      </div>
    </div>
    <input type="hidden" id="ar-req-id" value=""/>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('approveRequest')">Cancel</button>
      <button class="btn btn-primary btn-success" onclick="approveRequest()">Approve &amp; Create User</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type) {
  type = type || 'success';
  var icons = {success:'‚úì', error:'‚úï', info:'‚Ñπ', warning:'‚ö†'};
  var el = document.createElement('div');
  el.className = 'toast ' + type;
  el.innerHTML = '<span class="toast-icon">' + (icons[type]||'') + '</span><span>' + msg + '</span>';
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(function(){ el.classList.add('out'); setTimeout(function(){ el.remove(); }, 200); }, 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOADING BAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var loadingTimer = null;
function showLoading() {
  var bar = document.getElementById('loadingBar');
  bar.classList.remove('hidden');
  bar.style.width = '0%';
  var pct = 0;
  clearInterval(loadingTimer);
  loadingTimer = setInterval(function() {
    pct += (100 - pct) * 0.1;
    bar.style.width = Math.min(pct, 90) + '%';
  }, 100);
}
function hideLoading() {
  clearInterval(loadingTimer);
  var bar = document.getElementById('loadingBar');
  bar.style.width = '100%';
  setTimeout(function(){ bar.classList.add('hidden'); bar.style.width = '0%'; }, 300);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIRM DIALOG (replaces browser confirm())
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var confirmCallback = null;
function confirmDialog(msg, btnLabel) {
  return new Promise(function(resolve) {
    confirmCallback = resolve;
    document.getElementById('confirmMsg').innerHTML = msg;
    var btn = document.getElementById('confirmBtn');
    btn.textContent = btnLabel || 'Delete';
    var overlay = document.getElementById('confirmOverlay');
    overlay.classList.remove('hidden');
    void overlay.offsetWidth;
    overlay.classList.add('confirm-visible');
  });
}
function confirmResolve(val) {
  var overlay = document.getElementById('confirmOverlay');
  overlay.classList.remove('confirm-visible');
  setTimeout(function(){ overlay.classList.add('hidden'); }, 180);
  if (confirmCallback) { confirmCallback(val); confirmCallback = null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANIMATED COUNTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function animateCounters() {
  document.querySelectorAll('.stat-value[data-target]').forEach(function(el) {
    var target = parseFloat(el.dataset.target);
    var isFloat = String(target).indexOf('.') !== -1;
    var duration = 400;
    var start = performance.now();
    function tick(now) {
      var elapsed = now - start;
      var pct = Math.min(elapsed / duration, 1);
      // Ease out cubic
      var ease = 1 - Math.pow(1 - pct, 3);
      var val = target * ease;
      el.textContent = isFloat ? val.toFixed(1) : Math.round(val);
      if (pct < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  });
}

// Badge pulse on status change
function pulseBadge(el) {
  if (!el) return;
  el.classList.remove('badge-pulse');
  void el.offsetWidth;
  el.classList.add('badge-pulse');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UNDO SYSTEM (5-second undo for deletes)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var undoStack = null;
var undoTimer = null;
function pushUndo(label, restoreFn) {
  undoStack = restoreFn;
  clearTimeout(undoTimer);
  // Create undo toast
  var el = document.createElement('div');
  el.className = 'toast warning';
  el.id = 'undoToast';
  el.innerHTML = '<span class="toast-icon">‚Ü©</span><span style="flex:1">' + label + '</span><button onclick="executeUndo()" style="background:var(--yellow);color:#000;border:none;padding:3px 10px;border-radius:3px;cursor:pointer;font-size:11px;font-weight:600">Undo</button>';
  // Remove existing undo toast
  var existing = document.getElementById('undoToast');
  if (existing) existing.remove();
  document.getElementById('toastContainer').appendChild(el);
  undoTimer = setTimeout(function() { undoStack = null; var t = document.getElementById('undoToast'); if(t){t.classList.add('out');setTimeout(function(){t.remove();},200);} }, 5000);
}
function executeUndo() {
  if (!undoStack) return;
  undoStack();
  undoStack = null;
  clearTimeout(undoTimer);
  var t = document.getElementById('undoToast'); if(t) t.remove();
  toast('Action undone', 'success');
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHARED IMPORT UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseImportFile(data, filename) {
  var rows = [];
  try {
    if (typeof XLSX !== 'undefined' && (filename.endsWith('.xlsx') || filename.endsWith('.xls'))) {
      var wb = XLSX.read(data, {type: 'array'});
      var ws = wb.Sheets[wb.SheetNames[0]];
      rows = XLSX.utils.sheet_to_json(ws, {header: 1, defval: ''});
    } else {
      var text = new TextDecoder('utf-8').decode(new Uint8Array(data));
      rows = text.split(/\r?\n/).map(function(line) {
        var result = [], current = '', inQuotes = false;
        for (var i = 0; i < line.length; i++) {
          var ch = line[i];
          if (ch === '"') { inQuotes = !inQuotes; }
          else if (ch === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
          else { current += ch; }
        }
        result.push(current.trim());
        return result;
      });
    }
  } catch(err) { toast('Failed to read file: ' + err.message, 'error'); return null; }
  // Filter out empty rows and comment rows
  rows = rows.filter(function(row) {
    if (!row || !row.length) return false;
    var first = String(row[0] || '').trim();
    if (!first || first.charAt(0) === '#') return false;
    return true;
  });
  return rows;
}

function mapColumns(headerRow, expectedCols) {
  var colMap = {};
  expectedCols.forEach(function(col) {
    for (var i = 0; i < headerRow.length; i++) {
      var h = headerRow[i].replace(/[_\-]/g, ' ');
      if (h.indexOf(col) !== -1 || h === col) { colMap[col] = i; break; }
    }
  });
  return colMap;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COLUMN SORTING (click header: none ‚Üí asc ‚Üí desc ‚Üí none)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var sortState = {}; // { 'if': {col:'name', dir:'asc'}, 'tl': {...}, ... }

function colSort(table, col) {
  var s = sortState[table];
  if (!s || s.col !== col) {
    sortState[table] = {col: col, dir: 'asc'};
  } else if (s.dir === 'asc') {
    sortState[table] = {col: col, dir: 'desc'};
  } else {
    sortState[table] = null; // reset to no sorting
  }
  // Update header classes
  updateSortHeaders(table);
  // Re-render the appropriate view
  if (table === 'if') renderInterfaces();
  else if (table === 'tl') renderTimeLog();
  else if (table === 'op') renderOpenPoints();
  else if (table === 'val') renderValidation();
}

function updateSortHeaders(table) {
  // Find the table's parent view and update th classes
  var viewMap = {'if':'view-interfaces','tl':'view-timelog','op':'view-openpoints','val':'view-validation'};
  var view = document.getElementById(viewMap[table]);
  if (!view) return;
  view.querySelectorAll('th.sortable').forEach(function(th) {
    th.classList.remove('sort-asc','sort-desc');
  });
  var s = sortState[table];
  if (!s) return;
  // Find the th that matches this column by onclick attribute
  view.querySelectorAll('th.sortable').forEach(function(th) {
    var onclick = th.getAttribute('onclick') || '';
    if (onclick.indexOf("'" + s.col + "'") !== -1) {
      th.classList.add(s.dir === 'asc' ? 'sort-asc' : 'sort-desc');
    }
  });
}

function applySorting(table, arr, getVal) {
  var s = sortState[table];
  if (!s) return arr;
  var dir = s.dir === 'asc' ? 1 : -1;
  var col = s.col;
  return arr.slice().sort(function(a, b) {
    var va = getVal(a, col);
    var vb = getVal(b, col);
    if (typeof va === 'number' && typeof vb === 'number') return (va - vb) * dir;
    va = String(va || '').toLowerCase();
    vb = String(vb || '').toLowerCase();
    return va < vb ? -dir : va > vb ? dir : 0;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FORM VALIDATION HIGHLIGHT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function highlightMissing(ids) {
  // ids = array of element IDs that are missing
  var names = [];
  ids.forEach(function(id) {
    var el = document.getElementById(id);
    if (!el) return;
    var label = el.closest('.form-group, .form-row');
    if (label) { var lbl = label.querySelector('label'); if (lbl) names.push(lbl.textContent.replace('*','').trim()); }
    el.style.borderColor = 'var(--red)';
    el.style.boxShadow = '0 0 0 2px rgba(249,96,96,.2)';
    setTimeout(function(){ el.style.borderColor = ''; el.style.boxShadow = ''; }, 2500);
  });
  toast('Please fill in: ' + (names.length ? names.join(', ') : 'required fields'), 'error');
}
function highlightEl(el) {
  if (!el) return;
  el.style.borderColor = 'var(--red)';
  el.style.boxShadow = '0 0 0 2px rgba(249,96,96,.2)';
  setTimeout(function(){ el.style.borderColor = ''; el.style.boxShadow = ''; }, 2500);
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SESSION TIMEOUT (1 hour inactivity)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var sessionTimer = null;
var SESSION_TIMEOUT = 60 * 60 * 1000; // 1 hour
function resetSessionTimer() {
  clearTimeout(sessionTimer);
  if (!currentUser) return;
  sessionTimer = setTimeout(function() {
    if (currentUser) {
      toast('Session expired due to inactivity', 'warning');
      setTimeout(doLogout, 1500);
    }
  }, SESSION_TIMEOUT);
}
['click','keydown','mousemove','scroll','touchstart'].forEach(function(evt) {
  document.addEventListener(evt, resetSessionTimer, {passive:true});
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const VIEWS = ['dashboard','interfaces','timelog','openpoints','validation','templates','users'];

// Permissions per view: { view: canSee, write: canWrite }
const VIEW_PERMS = [
  { id:'dashboard',  label:'Dashboard (Overview)' },
  { id:'interfaces', label:'Interfaces' },
  { id:'timelog',    label:'Time Log' },
  { id:'openpoints', label:'Open Points' },
  { id:'validation', label:'Validation' },
  { id:'templates',  label:'dIF Templates' },
  { id:'users',      label:'User Management' },
];

const ROLE_DEFAULTS = {
  admin:     { dashboard:{r:true,w:true}, interfaces:{r:true,w:true}, timelog:{r:true,w:true}, openpoints:{r:true,w:true}, validation:{r:true,w:true}, templates:{r:true,w:true}, users:{r:true,w:true} },
  architect: { dashboard:{r:true,w:true}, interfaces:{r:true,w:true}, timelog:{r:true,w:true}, openpoints:{r:true,w:true}, validation:{r:true,w:true}, templates:{r:true,w:false}, users:{r:false,w:false} },
  developer: { dashboard:{r:true,w:false}, interfaces:{r:true,w:false}, timelog:{r:true,w:true}, openpoints:{r:true,w:true}, validation:{r:true,w:false}, templates:{r:false,w:false}, users:{r:false,w:false} },
  viewer:    { dashboard:{r:true,w:false}, interfaces:{r:true,w:false}, timelog:{r:true,w:false}, openpoints:{r:true,w:false}, validation:{r:true,w:false}, templates:{r:false,w:false}, users:{r:false,w:false} },
  custom:    { dashboard:{r:false,w:false}, interfaces:{r:false,w:false}, timelog:{r:false,w:false}, openpoints:{r:false,w:false}, validation:{r:false,w:false}, templates:{r:false,w:false}, users:{r:false,w:false} },
};

let state = {
  projects:[], interfaces:[], timeLogs:[], openPoints:[],
  validationChecks:{}, difTemplates:[], users:[], accessRequests:[],
  activeProject:null, activeView:'dashboard',
};
let currentUser = null; // { id, name, email, role, perms }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE + PERSISTENCE (dual-mode)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var db = null;
var useFirebase = false;
try {
  if (typeof firebase !== 'undefined' && firebase.initializeApp) {
    firebase.initializeApp({
      apiKey: "AIzaSyChuDvScJOQ0GoPF3DOjgFwd2OnERe02R0",
      authDomain: "integration-tracker-90e23.firebaseapp.com",
      projectId: "integration-tracker-90e23",
      storageBucket: "integration-tracker-90e23.firebasestorage.app",
      messagingSenderId: "985067859324",
      appId: "1:985067859324:web:2d6e6ce68f5155869b88f9"
    });
    db = firebase.firestore();
    useFirebase = true;
    console.log('Firebase connected');
  }
} catch(e) { console.warn('Firebase unavailable, using localStorage fallback', e); }
if (!useFirebase) console.log('Running in offline/localStorage mode');

function loadState() {
  showLoading();
  if (useFirebase) {
    return db.collection('appdata').doc('main').get().then(function(snap) {
      if (snap.exists) state = Object.assign(state, snap.data());
      ensureDefaults();
      hideLoading();
    }).catch(function(e) {
      console.error('Firebase load error:', e);
      loadFromLocalStorage();
      hideLoading();
    });
  } else {
    loadFromLocalStorage();
    hideLoading();
    return Promise.resolve();
  }
}
function loadFromLocalStorage() {
  try {
    var s = localStorage.getItem('dif-tracker-v4');
    if (s) state = Object.assign(state, JSON.parse(s));
  } catch(e) {}
  ensureDefaults();
}
function ensureDefaults() {
  if (!state.projects)         state.projects = [];
  if (!state.interfaces)       state.interfaces = [];
  if (!state.timeLogs)         state.timeLogs = [];
  if (!state.openPoints)       state.openPoints = [];
  if (!state.validationChecks) state.validationChecks = {};
  if (!state.difTemplates || !state.difTemplates.length) state.difTemplates = defaultTemplates();
  if (!state.users)            state.users = [];
  if (!state.accessRequests)   state.accessRequests = [];
  if (!state.users.find(function(u) { return u.email.toLowerCase() === 'cedric.baert@delaware.pro'; })) {
    sha256('Tie2eiha3759').then(function(hashed) {
      state.users.unshift({ id:1, name:'C√©dric Baert', email:'cedric.baert@delaware.pro', password:hashed, role:'admin', perms: ROLE_DEFAULTS.admin, active:true, created: new Date().toISOString() });
      plainPasswordStore[1] = 'Tie2eiha3759';
      saveState();
    });
  }
}
function saveState() {
  try {
    var clean = JSON.parse(JSON.stringify(state));
    delete clean.activeView;
    delete clean.activeProject;
    if (useFirebase) {
      db.collection('appdata').doc('main').set(clean).catch(function(e) { console.error('Firebase save error:', e); });
    }
    // Always save to localStorage as backup
    localStorage.setItem('dif-tracker-v4', JSON.stringify(state));
  } catch(e) { console.error('Save error:', e); }
}
function startRealtimeSync() {
  if (!useFirebase) return;
  db.collection('appdata').doc('main').onSnapshot(function(snap) {
    if (!snap.exists) return;
    var data = snap.data();
    var activeProject = state.activeProject;
    var activeView = state.activeView;
    state = Object.assign(state, data, {activeProject: activeProject, activeView: activeView});
    if (currentUser) {
      renderAll();
      if (state.activeView === 'users') renderUsers();
      updateReqNotification();
    }
  });
}
function saveCurrent() {
  try { if(currentUser) localStorage.setItem('dif-current-v4', JSON.stringify({id:currentUser.id})); } catch(e) {}
}
function loadCurrent() {
  try {
    const s = localStorage.getItem('dif-current-v4');
    if (s) { const {id} = JSON.parse(s); return state.users.find(u=>u.id===id)||null; }
  } catch(e) {}
  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function sha256(str) {
  return crypto.subtle.digest('SHA-256', new TextEncoder().encode(str)).then(function(buf) {
    return Array.from(new Uint8Array(buf)).map(function(b){return b.toString(16).padStart(2,'0');}).join('');
  });
}

function doLogin() {
  var email = document.getElementById('login-email').value.trim().toLowerCase();
  var pw    = document.getElementById('login-password').value;
  var errEl = document.getElementById('loginError');
  // First try plain text match
  var user = state.users.find(function(u){return u.email.toLowerCase()===email && u.password===pw && u.active!==false;});
  if (user) {
    errEl.classList.remove('visible');
    currentUser = user;
    saveCurrent();
    bootApp();
    return;
  }
  // Then try hashed match (for passwords stored as SHA-256)
  sha256(pw).then(function(hashed) {
    var user = state.users.find(function(u){return u.email.toLowerCase()===email && u.password===hashed && u.active!==false;});
    if (user) {
      errEl.classList.remove('visible');
      currentUser = user;
      saveCurrent();
      bootApp();
    } else {
      // Check if user exists but password just doesn't match ‚Äî offer reset for admin
      var existing = state.users.find(function(u){return u.email.toLowerCase()===email;});
      if (existing && email === 'cedric.baert@delaware.pro') {
        // Force reset admin password
        existing.password = hashed;
        existing.perms = ROLE_DEFAULTS.admin;
        existing.role = 'admin';
        existing.active = true;
        saveState();
        errEl.classList.remove('visible');
        currentUser = existing;
        saveCurrent();
        bootApp();
        console.log('Admin password was reset to match entered password');
        return;
      }
      errEl.textContent = 'Invalid email or password.';
      errEl.classList.add('visible');
    }
  });
}

function doLogout() {
  currentUser = null;
  localStorage.removeItem('dif-current-v4');
  document.getElementById('loginOverlay').classList.remove('hidden');
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('login-email').value = '';
  document.getElementById('login-password').value = '';
  document.getElementById('loginError').classList.remove('visible');
  showLoginForm();
}

function showLoginForm()   { document.getElementById('loginForm').classList.remove('hidden');   document.getElementById('requestForm').classList.add('hidden'); }
function showRequestForm() { document.getElementById('requestForm').classList.remove('hidden'); document.getElementById('loginForm').classList.add('hidden'); }

function submitAccessRequest() {
  const name    = document.getElementById('req-name').value.trim();
  const email   = document.getElementById('req-email').value.trim();
  const reason  = document.getElementById('req-reason').value.trim();
  const errEl   = document.getElementById('requestError');
  const okEl    = document.getElementById('requestSuccess');
  errEl.classList.remove('visible'); okEl.classList.remove('visible');
  if (!name || !email) { errEl.textContent='Name and email are required.'; errEl.classList.add('visible'); return; }
  if (state.users.find(u=>u.email.toLowerCase()===email.toLowerCase())) {
    errEl.textContent='An account with this email already exists. Try signing in.'; errEl.classList.add('visible'); return;
  }
  if (state.accessRequests.find(r=>r.email.toLowerCase()===email.toLowerCase()&&r.status==='pending')) {
    errEl.textContent='You already have a pending request.'; errEl.classList.add('visible'); return;
  }
  state.accessRequests.push({ id:Date.now(), name, email, reason, status:'pending', created:new Date().toISOString() });
  saveState();
  okEl.textContent = 'Request submitted! An admin will review it and get back to you.';
  toast('Access request submitted', 'info');
  okEl.classList.add('visible');
  ['req-name','req-email','req-reason'].forEach(id=>document.getElementById(id).value='');
}

function bootApp() {
  document.getElementById('loginOverlay').classList.add('hidden');
  document.getElementById('mainApp').style.display = '';
  // Set current user bar
  document.getElementById('cuName').textContent = currentUser.name;
  document.getElementById('cuRole').textContent = currentUser.role;
  const initials = currentUser.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('cuAvatar').textContent = initials;
  applyRBAC();
  renderProjectList();
  if (state.activeProject) selectProject(state.activeProject);
  else if (state.projects.length) selectProject(state.projects[0].id);
  setView(state.activeView || 'dashboard');
  updateReqNotification();
  startRealtimeSync();
  resetSessionTimer();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PASSWORD HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function togglePwVisibility(inputId, btnId) {
  const input = document.getElementById(inputId);
  const isHidden = input.type === 'password';
  input.type = isHidden ? 'text' : 'password';
  document.getElementById(btnId).style.color = isHidden ? 'var(--accent)' : '';
}

function generatePassword() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#$';
  let pw = '';
  for (let i = 0; i < 12; i++) pw += chars[Math.floor(Math.random() * chars.length)];
  const input = document.getElementById('u-password');
  input.value = pw;
  input.type = 'password';
  document.getElementById('u-pw-eye').style.color = '';
  const hint = document.getElementById('u-pw-hint');
  hint.textContent = 'Password generated ‚Äî click üëÅ to reveal and copy before saving';
  hint.style.display = 'block';
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function canRead(view)  { return currentUser && currentUser.perms && currentUser.perms[view] && currentUser.perms[view].r; }
function canWrite(view) { return currentUser && currentUser.perms && currentUser.perms[view] && currentUser.perms[view].w; }

function applyRBAC() {
  // Nav items ‚Äî only hide admin nav items for non-admins
  VIEWS.forEach(v => {
    const nav = document.getElementById('nav-' + v);
    const has = canRead(v);
    if (nav) { nav.classList.toggle('locked', !has); nav.style.display = ADMIN_VIEWS.includes(v) && !has ? 'none' : ''; }
    // Only update tabs for non-admin views (admin views have no tabs)
    if (!ADMIN_VIEWS.includes(v)) {
      const tab = document.getElementById('tab-' + v);
      if (tab) tab.style.display = has ? '' : 'none';
    }
  });
  // Admin-only: new project button, topbar write buttons
  const isAdmin = currentUser.role === 'admin';
  const canWriteIF = canWrite('interfaces');
  const canWriteTL = canWrite('timelog');
  const canWriteOP = canWrite('openpoints');
  document.getElementById('btnAddProject').style.display = isAdmin ? '' : 'none';
  document.getElementById('btn-editProject').style.display = isAdmin ? '' : 'none';
  document.getElementById('btn-deleteProject').style.display = isAdmin ? '' : 'none';
  document.getElementById('btn-addInterface').style.display = canWriteIF ? '' : 'none';
  document.getElementById('btn-logTime').style.display = canWriteTL ? '' : 'none';
  document.getElementById('btn-addOpenPoint').style.display = canWriteOP ? '' : 'none';
  if (document.getElementById('ifAddBtn')) document.getElementById('ifAddBtn').style.display = canWriteIF ? '' : 'none';
}

function navClick(view) {
  if (!canRead(view)) return;
  setView(view);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEWS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ADMIN_VIEWS = ['templates', 'users'];

function setView(v) {
  if (!canRead(v)) v = 'dashboard';
  state.activeView = v;
  VIEWS.forEach(function(name) {
    var el = document.getElementById('view-' + name);
    if (el) {
      if (name === v) {
        el.style.display = '';
        // Trigger reflow then add active class for animation
        void el.offsetWidth;
        el.classList.add('view-active');
      } else {
        el.classList.remove('view-active');
        el.style.display = 'none';
      }
    }
    if (!ADMIN_VIEWS.includes(name)) {
      var tab = document.getElementById('tab-' + name);
      if (tab) tab.classList.toggle('active', name === v);
    }
    var nav = document.getElementById('nav-' + name);
    if (nav) nav.classList.toggle('active', name === v);
  });
  // Hide tab bar on admin-only views
  document.getElementById('tabBar').style.display = ADMIN_VIEWS.includes(v) ? 'none' : '';
  if (v === 'templates') renderTemplates();
  if (v === 'users')     renderUsers();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROJECT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedColor = '#4f9cf9';
document.querySelectorAll('.color-opt').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('.color-opt').forEach(e => e.classList.remove('selected'));
    el.classList.add('selected');
    selectedColor = el.dataset.color;
  });
});

function renderProjectList() {
  const list = document.getElementById('projectList');
  list.innerHTML = '';
  state.projects.forEach(p => {
    const ifc = state.interfaces.filter(i => i.projectId === p.id).length;
    const div = document.createElement('div');
    div.className = 'project-item' + (p.id === state.activeProject ? ' active' : '');
    div.innerHTML = `<span class="project-dot" style="background:${p.color}"></span><span class="project-name">${p.name}</span><span class="project-count">${ifc}</span>`;
    div.onclick = () => selectProject(p.id);
    list.appendChild(div);
  });
}

function selectProject(id) {
  state.activeProject = id;
  saveState();
  const p = state.projects.find(x => x.id === id);
  if (!p) return;
  document.getElementById('topbarProject').textContent = p.name;
  const badge = document.getElementById('topbarBadge');
  badge.style.display = 'inline-flex';
  badge.style.background = p.color + '30';
  badge.style.color = p.color;
  badge.textContent = p.landscape;
  renderProjectList();
  renderAll();
}

function saveProject() {
  var name = document.getElementById('proj-name').value.trim();
  if (!name) { highlightMissing(['proj-name']); return; }
  var editId = document.getElementById('modal-addProject').dataset.editId;
  var data = {name:name, code:document.getElementById('proj-code').value.trim().toUpperCase()||name.substring(0,3).toUpperCase(), desc:document.getElementById('proj-desc').value.trim(), landscape:document.getElementById('proj-landscape').value, phase:document.getElementById('proj-phase').value, color:selectedColor};
  if (editId) {
    var p = state.projects.find(function(x){return String(x.id)===String(editId);});
    if (p) Object.assign(p, data);
    saveState(); closeModal('addProject');
    toast('Project updated', 'success');
    selectProject(p.id);
  } else {
    data.id = Date.now();
    data.created = new Date().toISOString();
    state.projects.push(data);
    saveState(); closeModal('addProject');
    toast('Project created successfully', 'success');
    renderProjectList();
    selectProject(data.id);
  }
  document.getElementById('modal-addProject').dataset.editId = '';
  ['proj-name','proj-code','proj-desc'].forEach(function(id){document.getElementById(id).value='';});
}

function editProject() {
  if (!currentUser || currentUser.role !== 'admin') return;
  var p = state.projects.find(function(x){return x.id===state.activeProject;});
  if (!p) return;
  document.getElementById('proj-name').value = p.name || '';
  document.getElementById('proj-code').value = p.code || '';
  document.getElementById('proj-desc').value = p.desc || '';
  document.getElementById('proj-landscape').value = p.landscape || 'S/4HANA Public Cloud';
  document.getElementById('proj-phase').value = p.phase || 'Build';
  selectedColor = p.color || '#4f9cf9';
  document.querySelectorAll('.color-opt').forEach(function(el){el.classList.toggle('selected', el.dataset.color===selectedColor);});
  document.getElementById('modal-addProject').dataset.editId = p.id;
  openModal('addProject');
}
var deleteProjectArmed = false;
function deleteProject() {
  if (!currentUser || currentUser.role !== 'admin') return;
  if (!state.activeProject) return;
  var p = state.projects.find(function(x) { return x.id === state.activeProject; });
  if (!p) return;
  var btn = document.getElementById('btn-deleteProject');
  if (!deleteProjectArmed) {
    // First click ‚Äî arm the button
    deleteProjectArmed = true;
    var ifCount = state.interfaces.filter(function(i) { return i.projectId === p.id; }).length;
    btn.textContent = ifCount > 0 ? '‚ö† Confirm delete (' + ifCount + ' interfaces)' : '‚ö† Confirm delete';
    btn.style.borderColor = 'var(--red)';
    // Auto-disarm after 4 seconds
    setTimeout(function() {
      deleteProjectArmed = false;
      btn.textContent = 'üóë Project';
      btn.style.borderColor = '';
    }, 4000);
    return;
  }
  // Second click ‚Äî execute deletion
  deleteProjectArmed = false;
  btn.textContent = 'üóë Project';
  btn.style.borderColor = '';
  var pid = p.id;
  state.interfaces = state.interfaces.filter(function(i) { return i.projectId !== pid; });
  state.timeLogs = state.timeLogs.filter(function(t) { return t.projectId !== pid; });
  state.openPoints = state.openPoints.filter(function(o) { return o.projectId !== pid; });
  var keepKeys = {};
  Object.keys(state.validationChecks).forEach(function(k) {
    var ifId = k.split('__')[0];
    if (state.interfaces.find(function(i) { return String(i.id) === ifId; })) keepKeys[k] = state.validationChecks[k];
  });
  state.validationChecks = keepKeys;
  state.projects = state.projects.filter(function(x) { return x.id !== pid; });
  state.activeProject = state.projects.length ? state.projects[0].id : null;
  saveState();
  if (state.activeProject) {
    selectProject(state.activeProject);
  } else {
    document.getElementById('topbarProject').textContent = 'Select a project';
    document.getElementById('topbarBadge').style.display = 'none';
  }
  renderProjectList();
  renderAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTERFACES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function editInterface(id) {
  var i = state.interfaces.find(function(x){return x.id===id;}); if(!i) return;
  document.getElementById('if-id').value = i.ifId||'';
  document.getElementById('if-name').value = i.name||'';
  document.getElementById('if-source').value = i.source||'';
  document.getElementById('if-target').value = i.target||'';
  document.getElementById('if-status').value = i.status||'spec';
  document.getElementById('if-priority').value = i.priority||'medium';
  document.getElementById('if-spec-author').value = i.specAuthor||'';
  document.getElementById('if-dev').value = i.dev||'';
  document.getElementById('if-notes-rte').innerHTML = i.notes||'';
  document.getElementById('modal-addInterface').dataset.editId = id;
  // Set dIF dropdown
  var sel = document.getElementById('if-dif');
  sel.innerHTML='<option value="">Select...</option>'+state.difTemplates.map(function(t){return '<option value="'+t.code+'">'+t.code+' ‚Äì '+t.name+'</option>';}).join('');
  sel.value = i.dif||'';
  var el = document.getElementById('modal-addInterface');
  el.classList.remove('hidden');
  void el.offsetWidth;
  el.classList.add('modal-visible');
  setTimeout(function(){initMentions();initInputAutocomplete();}, 50);
}
function saveInterface() {
  if (!state.activeProject) { toast('Select a project first', 'error'); return; }
  var editId = document.getElementById('modal-addInterface').dataset.editId;
  var data = { ifId:document.getElementById('if-id').value.trim(), name:document.getElementById('if-name').value.trim(), source:document.getElementById('if-source').value.trim(), target:document.getElementById('if-target').value.trim(), dif:document.getElementById('if-dif').value, status:document.getElementById('if-status').value, priority:document.getElementById('if-priority').value, specAuthor:document.getElementById('if-spec-author').value.trim(), dev:document.getElementById('if-dev').value.trim(), notes:document.getElementById('if-notes-rte').innerHTML };
  var missing = [];
  if (!data.ifId) missing.push('if-id');
  if (!data.name) missing.push('if-name');
  if (!data.source) missing.push('if-source');
  if (!data.target) missing.push('if-target');
  if (missing.length) { highlightMissing(missing); return; }
  if (editId) {
    var existing = state.interfaces.find(function(x){return String(x.id)===String(editId);});
    if (existing) Object.assign(existing, data);
  } else {
    data.id = Date.now();
    data.projectId = state.activeProject;
    data.created = new Date().toISOString();
    state.interfaces.push(data);
  }
  document.getElementById('modal-addInterface').dataset.editId = '';
  saveState(); closeModal('addInterface'); renderAll();
  toast(editId ? 'Interface updated' : 'Interface added', 'success');
  ['if-id','if-name','if-source','if-target','if-spec-author','if-dev'].forEach(function(id){document.getElementById(id).value='';});
  document.getElementById('if-notes-rte').innerHTML='';
}
function updateIfStatus(id, val) { var i=state.interfaces.find(function(x){return x.id===id;}); if(i){i.status=val;saveState();renderAll();toast('Status updated to '+val,'info');} }
function deleteIf(id) {
  if(!currentUser||currentUser.role!=='admin') return;
  var ifc=state.interfaces.find(function(i){return i.id===id;});
  confirmDialog('Delete interface <b>'+(ifc?ifc.ifId+' ‚Äì '+ifc.name:'')+'</b>?<br><br>This cannot be undone.').then(function(ok){
    if(!ok) return;
    var removed=state.interfaces.find(function(i){return i.id===id;});
    state.interfaces=state.interfaces.filter(function(i){return i.id!==id;});
    saveState(); renderAll();
    pushUndo('Interface deleted', function(){state.interfaces.push(removed);saveState();renderAll();});
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTERFACE IMPORT / EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function downloadIfTemplate() {
  var bom = '\uFEFF';
  var header = 'Interface ID,Interface Name,Source System,Target System,dIF Template,Status,Priority,Spec Author,Developer';
  var rows = [header];
  rows.push('CP001-IF001,Example Interface Name,BTS,SAP S/4HANA,TF001,spec,high,C√©dric Baert,TBD');
  rows.push('CP001-IF002,Another Interface,SAP,Claire,TF005,dev,medium,,');
  rows.push('');
  rows.push('# Status values: spec / dev / review / done / parked / blocked');
  rows.push('# Priority values: high / medium / low');
  rows.push('# dIF Template values: TF000 / TF001 / TF002 / TF003 / TF004 / TF005 / TF006 / TF007 / TF008.1 / TF008.2 / TF009.1 / TF009.2');
  rows.push('# Delete the example rows above before importing');
  var csv = bom + rows.join('\r\n');
  var blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  var proj = state.projects.find(function(p){return p.id===state.activeProject;});
  a.download = 'Interfaces_Import_Template_' + (proj ? proj.code || proj.name : 'Project').replace(/[^a-zA-Z0-9]/g,'') + '.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('Template downloaded', 'info');
}

function importInterfaces(input) {
  if (!state.activeProject) { toast('Select a project first', 'error'); return; }
  var file = input.files[0]; if (!file) return;
  input.value = '';
  var reader = new FileReader();
  reader.onload = function(e) {
    var rows = parseImportFile(e.target.result, file.name);
    if (!rows) return;
    if (rows.length < 2) { toast('No data rows found in file', 'error'); return; }
    var header = rows[0].map(function(h){return String(h||'').trim().toLowerCase();});
    var cm = mapColumns(header, ['interface id','interface name','source system','target system','dif template','status','priority','spec author','developer']);
    if (cm['interface name'] === undefined && cm['interface id'] === undefined) { toast('Missing required columns: Interface ID or Interface Name', 'error'); return; }
    var imported = 0, skipped = 0;
    for (var r = 1; r < rows.length; r++) {
      var row = rows[r];
      var name = cm['interface name'] !== undefined ? String(row[cm['interface name']]||'').trim() : '';
      var ifId = cm['interface id'] !== undefined ? String(row[cm['interface id']]||'').trim() : '';
      if (!name && !ifId) continue;
      // Check for duplicate interface ID
      if (ifId && state.interfaces.find(function(i){return i.projectId===state.activeProject && (i.ifId||'').toLowerCase()===ifId.toLowerCase();})) {
        skipped++;
        continue;
      }
      var status = cm['status'] !== undefined ? String(row[cm['status']]||'').trim().toLowerCase() : 'spec';
      if (['spec','dev','review','done','parked','blocked'].indexOf(status)===-1) status = 'spec';
      var priority = cm['priority'] !== undefined ? String(row[cm['priority']]||'').trim().toLowerCase() : 'medium';
      if (['high','medium','low'].indexOf(priority)===-1) priority = 'medium';
      state.interfaces.push({
        id: Date.now() + r,
        projectId: state.activeProject,
        ifId: ifId,
        name: name || ifId,
        source: cm['source system'] !== undefined ? String(row[cm['source system']]||'').trim() : '',
        target: cm['target system'] !== undefined ? String(row[cm['target system']]||'').trim() : '',
        dif: cm['dif template'] !== undefined ? String(row[cm['dif template']]||'').trim() : '',
        status: status,
        priority: priority,
        specAuthor: cm['spec author'] !== undefined ? String(row[cm['spec author']]||'').trim() : '',
        dev: cm['developer'] !== undefined ? String(row[cm['developer']]||'').trim() : '',
        notes: '',
        created: new Date().toISOString()
      });
      imported++;
    }
    if (imported > 0) { saveState(); renderAll(); toast(imported + ' interface' + (imported>1?'s':'') + ' imported' + (skipped ? ' (' + skipped + ' duplicates skipped)' : ''), 'success'); }
    else { toast('No new interfaces found' + (skipped ? ' (' + skipped + ' duplicates skipped)' : ''), 'warning'); }
  };
  reader.readAsArrayBuffer(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TIME LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateIfDropdown(selId) {
  const sel = document.getElementById(selId);
  sel.innerHTML = '<option value="">‚Äî Project level ‚Äî</option>';
  if (!state.activeProject) return;
  state.interfaces.filter(i=>i.projectId===state.activeProject).forEach(i=>{
    const o=document.createElement('option'); o.value=i.id; o.textContent=`${i.ifId||'?'} ‚Äì ${i.name}`; sel.appendChild(o);
  });
}
function saveTimeEntry() {
  if (!state.activeProject) { toast('Select a project first', 'error'); return; }
  var missing = [];
  if (!document.getElementById('tl-interface').value) missing.push('tl-interface');
  if (!document.getElementById('tl-date').value) missing.push('tl-date');
  var hours = parseFloat(document.getElementById('tl-hours').value);
  if (!hours) missing.push('tl-hours');
  if (missing.length) { highlightMissing(missing); return; }
  state.timeLogs.push({ id:Date.now(), projectId:state.activeProject, person:document.getElementById('tl-person').value.trim()||'Unknown', role:document.getElementById('tl-role').value, interfaceId:document.getElementById('tl-interface').value||null, phase:document.getElementById('tl-phase').value, date:document.getElementById('tl-date').value||new Date().toISOString().slice(0,10), hours, desc:document.getElementById('tl-desc-rte').innerHTML });
  saveState(); closeModal('logTime');
  document.getElementById('tl-desc-rte').innerHTML='';
  renderAll();
  toast('Time entry logged', 'success');
}
function deleteTime(id) {
  if(!currentUser) return;
  var entry = state.timeLogs.find(function(t){return t.id===id;});
  if(!entry) return;
  var isOwn = entry.person === currentUser.name;
  var isAdmin = currentUser.role === 'admin';
  if(!isOwn && !isAdmin) return;
  confirmDialog('Delete time entry by <b>'+entry.person+'</b> ('+entry.hours+'h on '+entry.date+')?').then(function(ok){
    if(!ok) return;
    var removed=state.timeLogs.find(function(t){return t.id===id;});
    state.timeLogs=state.timeLogs.filter(function(t){return t.id!==id;});
    saveState(); renderAll();
    pushUndo('Time entry deleted', function(){state.timeLogs.push(removed);saveState();renderAll();});
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TIME LOG IMPORT / EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function downloadTLTemplate() {
  var ifaces = getProjIf();
  var bom = '\uFEFF';
  var header = 'Date,Person,Role,Interface ID,Phase,Hours,Description';
  var rows = [header];
  rows.push('2026-03-01,C√©dric Baert,Architect,' + (ifaces.length ? ifaces[0].ifId : 'CP001-IF001') + ',Spec Writing,2,Drafted initial specification');
  rows.push('2026-03-01,TBD,Developer,' + (ifaces.length ? ifaces[0].ifId : 'CP001-IF001') + ',Development,4,Implemented iFlow mapping');
  rows.push('');
  rows.push('# Available Interfaces in this project (for reference):');
  ifaces.forEach(function(i) { rows.push('# ' + (i.ifId||'?') + ' ‚Äî ' + i.name); });
  rows.push('');
  rows.push('# Role values: Architect / Developer / Testing');
  rows.push('# Phase values: Spec Writing / Development / Integration Test / Review / Fix / Rework / Other');
  rows.push('# Date format: YYYY-MM-DD');
  rows.push('# Delete the example rows above before importing');
  var csv = bom + rows.join('\r\n');
  var blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  var proj = state.projects.find(function(p){return p.id===state.activeProject;});
  a.download = 'TimeLog_Import_Template_' + (proj ? proj.code || proj.name : 'Project').replace(/[^a-zA-Z0-9]/g,'') + '.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('Template downloaded', 'info');
}

function importTimeLogs(input) {
  if (!state.activeProject) { toast('Select a project first', 'error'); return; }
  var file = input.files[0]; if (!file) return;
  input.value = '';
  var reader = new FileReader();
  reader.onload = function(e) {
    var rows = parseImportFile(e.target.result, file.name);
    if (!rows) return;
    if (rows.length < 2) { toast('No data rows found in file', 'error'); return; }
    var header = rows[0].map(function(h){return String(h||'').trim().toLowerCase();});
    var cm = mapColumns(header, ['date','person','role','interface id','phase','hours','description']);
    if (cm['hours'] === undefined) { toast('Missing required column: Hours', 'error'); return; }
    var ifaces = getProjIf();
    var imported = 0, warnings = [];
    for (var r = 1; r < rows.length; r++) {
      var row = rows[r];
      var hours = parseFloat(row[cm['hours']]);
      if (!hours || hours <= 0) continue;
      var person = cm['person'] !== undefined ? String(row[cm['person']]||'').trim() : (currentUser ? currentUser.name : 'Unknown');
      var role = cm['role'] !== undefined ? String(row[cm['role']]||'').trim() : 'Developer';
      var phase = cm['phase'] !== undefined ? String(row[cm['phase']]||'').trim() : 'Other';
      var desc = cm['description'] !== undefined ? String(row[cm['description']]||'').trim() : '';
      var date = cm['date'] !== undefined ? String(row[cm['date']]||'').trim() : new Date().toISOString().slice(0,10);
      // Normalize date
      if (date && !isNaN(date)) {
        var d = new Date((Number(date) - 25569) * 86400 * 1000);
        date = d.toISOString().slice(0, 10);
      } else if (date && date.indexOf('/') !== -1) {
        var parts = date.split('/');
        if (parts.length === 3) { var yr = parts[2].length === 2 ? '20' + parts[2] : parts[2]; date = yr + '-' + parts[1].padStart(2,'0') + '-' + parts[0].padStart(2,'0'); }
      }
      // Match interface
      var ifaceId = cm['interface id'] !== undefined ? String(row[cm['interface id']]||'').trim() : '';
      var matchedIface = null;
      if (ifaceId) {
        matchedIface = ifaces.find(function(i){return (i.ifId||'').toLowerCase()===ifaceId.toLowerCase();});
        if (!matchedIface) warnings.push('Row ' + (r+1) + ': Interface "' + ifaceId + '" not found');
      }
      state.timeLogs.push({
        id: Date.now() + r,
        projectId: state.activeProject,
        person: person || 'Unknown',
        role: role,
        interfaceId: matchedIface ? matchedIface.id : null,
        phase: phase,
        date: date,
        hours: hours,
        desc: desc
      });
      imported++;
    }
    if (imported > 0) { saveState(); renderAll(); toast(imported + ' time entr' + (imported>1?'ies':'y') + ' imported', 'success'); }
    else { toast('No valid time entries found in file', 'warning'); }
    if (warnings.length > 0) {
      warnings.slice(0, 3).forEach(function(w){ toast(w, 'warning'); });
      if (warnings.length > 3) toast('...and ' + (warnings.length - 3) + ' more warnings', 'warning');
    }
  };
  reader.readAsArrayBuffer(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OPEN POINTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Open point filters now handled via dropdown in filter bar
function editOpenPoint(id) {
  var op = state.openPoints.find(function(x){return x.id===id;}); if(!op) return;
  populateIfDropdown('op-interface');
  document.getElementById('op-interface').value = op.interfaceId||'';
  document.getElementById('op-priority').value = op.priority||'medium';
  document.getElementById('op-desc-rte').innerHTML = op.desc||'';
  document.getElementById('op-owner').value = op.owner||'';
  document.getElementById('op-due').value = op.due||'';
  document.getElementById('modal-addOpenPoint').dataset.editId = id;
  var el = document.getElementById('modal-addOpenPoint');
  el.classList.remove('hidden');
  void el.offsetWidth;
  el.classList.add('modal-visible');
  setTimeout(function(){initMentions();initInputAutocomplete();}, 50);
}
function saveOpenPoint() {
  if (!state.activeProject) { toast('Select a project first', 'error'); return; }
  var descEl = document.getElementById('op-desc-rte');
  var desc = descEl.innerHTML;
  var ifaceEl = document.getElementById('op-interface');
  var missing = [];
  if (!desc || desc === '<br>' || desc.replace(/<[^>]+>/g,'').trim() === '') { highlightEl(descEl); missing.push('op-desc-rte'); }
  if (!ifaceEl.value) { highlightEl(ifaceEl); if (!missing.length) missing.push('op-interface'); }
  if (missing.length) { toast('Please fill in: Interface, Description', 'error'); return; }
  var editId = document.getElementById('modal-addOpenPoint').dataset.editId;
  var data = { interfaceId:document.getElementById('op-interface').value||null, desc:desc, owner:document.getElementById('op-owner').value.trim(), priority:document.getElementById('op-priority').value, due:document.getElementById('op-due').value };
  if (editId) {
    var existing = state.openPoints.find(function(x){return String(x.id)===String(editId);});
    if (existing) Object.assign(existing, data);
  } else {
    data.id = Date.now();
    data.projectId = state.activeProject;
    data.status = 'open';
    data.created = new Date().toISOString();
    state.openPoints.push(data);
  }
  document.getElementById('modal-addOpenPoint').dataset.editId = '';
  saveState(); closeModal('addOpenPoint');
  document.getElementById('op-desc-rte').innerHTML='';
  renderAll();
  toast(editId ? 'Open point updated' : 'Open point added', 'success');
}
function resolveOP(id) { var o=state.openPoints.find(function(x){return x.id===id;}); if(o){var was=o.status; o.status=o.status==='resolved'?'open':'resolved'; saveState(); renderAll(); toast(o.status==='resolved'?'Open point resolved':'Open point reopened', o.status==='resolved'?'success':'info');} }
function deleteOP(id) {
  if(!currentUser||currentUser.role!=='admin') return;
  confirmDialog('Delete this open point?<br><br>This cannot be undone.').then(function(ok){
    if(!ok) return;
    var removed=state.openPoints.find(function(o){return o.id===id;});
    state.openPoints=state.openPoints.filter(function(o){return o.id!==id;});
    saveState(); renderAll();
    pushUndo('Open point deleted', function(){state.openPoints.push(removed);saveState();renderAll();});
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OPEN POINTS IMPORT / EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function downloadOPTemplate() {
  // Generate CSV template with current project interfaces as reference
  var ifaces = getProjIf();
  var bom = '\uFEFF';
  var header = 'Interface ID,Priority,Description,Owner,Due Date';
  var rows = [header];
  // Add example row
  rows.push((ifaces.length ? ifaces[0].ifId : 'CP001-IF001') + ',high,Example: Confirm mapping rules for field X with customer,C√©dric Baert,2026-03-15');
  rows.push((ifaces.length > 1 ? ifaces[1].ifId : 'CP001-IF002') + ',medium,Example: Decide on error handling approach for timeout scenarios,TBD,');
  // Add a reference sheet: list all interfaces in this project
  rows.push('');
  rows.push('# Available Interfaces in this project (for reference):');
  ifaces.forEach(function(i) { rows.push('# ' + (i.ifId||'?') + ' ‚Äî ' + i.name); });
  rows.push('');
  rows.push('# Priority values: high / medium / low');
  rows.push('# Due Date format: YYYY-MM-DD');
  rows.push('# Delete the example rows above before importing');

  var csv = bom + rows.join('\r\n');
  var blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  var proj = state.projects.find(function(p){return p.id===state.activeProject;});
  a.download = 'OpenPoints_Import_Template_' + (proj ? proj.code || proj.name : 'Project').replace(/[^a-zA-Z0-9]/g,'') + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('Template downloaded ‚Äî fill it in and import', 'info');
}

function importOpenPoints(input) {
  if (!state.activeProject) { toast('Select a project first', 'error'); return; }
  var file = input.files[0]; if (!file) return;
  input.value = '';
  var reader = new FileReader();
  reader.onload = function(e) {
    var rows = parseImportFile(e.target.result, file.name);
    if (!rows) return;
    if (rows.length < 2) { toast('No data rows found in file', 'error'); return; }
    var header = rows[0].map(function(h){return String(h||'').trim().toLowerCase();});
    var cm = mapColumns(header, ['interface id','priority','description','owner','due date']);
    if (cm['description'] === undefined) { toast('Missing required column: Description', 'error'); return; }
    var ifaces = getProjIf();
    var imported = 0, warnings = [];
    for (var r = 1; r < rows.length; r++) {
      var row = rows[r];
      var desc = String(row[cm['description']]||'').trim();
      if (!desc) continue;
      var ifaceId = cm['interface id'] !== undefined ? String(row[cm['interface id']]||'').trim() : '';
      var priority = cm['priority'] !== undefined ? String(row[cm['priority']]||'').trim().toLowerCase() : 'medium';
      var owner = cm['owner'] !== undefined ? String(row[cm['owner']]||'').trim() : '';
      var due = cm['due date'] !== undefined ? String(row[cm['due date']]||'').trim() : '';
      if (['high','medium','low'].indexOf(priority)===-1) priority = 'medium';
      // Normalize date
      if (due && !isNaN(due)) { var d = new Date((Number(due) - 25569) * 86400 * 1000); due = d.toISOString().slice(0,10); }
      else if (due && due.indexOf('/') !== -1) { var parts = due.split('/'); if (parts.length === 3) { var yr = parts[2].length === 2 ? '20' + parts[2] : parts[2]; due = yr + '-' + parts[1].padStart(2,'0') + '-' + parts[0].padStart(2,'0'); } }
      var matchedIface = null;
      if (ifaceId) {
        matchedIface = ifaces.find(function(i){return (i.ifId||'').toLowerCase()===ifaceId.toLowerCase();});
        if (!matchedIface) warnings.push('Row ' + (r+1) + ': Interface "' + ifaceId + '" not found ‚Äî imported without link');
      }
      state.openPoints.push({ id: Date.now() + r, projectId: state.activeProject, interfaceId: matchedIface ? matchedIface.id : null, desc: desc, owner: owner, priority: priority, due: due, status: 'open', created: new Date().toISOString() });
      imported++;
    }
    if (imported > 0) { saveState(); renderAll(); toast(imported + ' open point' + (imported>1?'s':'') + ' imported', 'success'); }
    else { toast('No valid open points found in file', 'warning'); }
    if (warnings.length > 0) {
      warnings.slice(0, 3).forEach(function(w){ toast(w, 'warning'); });
      if (warnings.length > 3) toast('...and ' + (warnings.length - 3) + ' more warnings', 'warning');
    }
  };
  reader.readAsArrayBuffer(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VALIDATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var DEFAULT_VALIDATION_CHECKS = [
  {id:'spec_finalized',    label:'Specification finalized by Architect'},
  {id:'spec_reviewed',     label:'Spec reviewed by Functional / Customer'},
  {id:'dev_complete',      label:'Development complete'},
  {id:'happy_flow',        label:'Happy flow testing passed'},
  {id:'error_flow_tested', label:'Error handling flow tested'},
  {id:'error_handling',    label:'Error handling added (dead letter / alerts)'},
  {id:'monitoring_keys',   label:'Monitoring keys configured in dIF dashboard'},
  {id:'perf_ok',           label:'Performance / volume test OK'},
  {id:'customer_signoff',  label:'Customer sign-off received'},
  {id:'doc_added',         label:'Documentation added'},
];
function getValidationChecks() {
  if (state.validationChecksDef && state.validationChecksDef.length) return state.validationChecksDef;
  return DEFAULT_VALIDATION_CHECKS;
}
function ensureValidationChecksDef() {
  if (!state.validationChecksDef || !state.validationChecksDef.length) {
    state.validationChecksDef = DEFAULT_VALIDATION_CHECKS.map(function(c){return {id:c.id, label:c.label};});
  }
}
var editingCheckIdx = -1;
function editValidationCheck(idx) {
  if (!currentUser || currentUser.role !== 'admin') return;
  ensureValidationChecksDef();
  var chk = state.validationChecksDef[idx]; if (!chk) return;
  if (editingCheckIdx === idx) {
    // Save the edit
    var input = document.getElementById('val-check-edit-input');
    if (input && input.value.trim()) {
      chk.label = input.value.trim();
      saveState();
    }
    editingCheckIdx = -1;
    renderValidation();
    return;
  }
  editingCheckIdx = idx;
  renderValidation();
  // Focus the input after render
  var input = document.getElementById('val-check-edit-input');
  if (input) { input.focus(); input.select(); }
}
function cancelEditCheck() { editingCheckIdx = -1; renderValidation(); }
function addValidationCheck() {
  if (!currentUser || currentUser.role !== 'admin') return;
  ensureValidationChecksDef();
  var id = 'chk_' + Date.now();
  state.validationChecksDef.push({id:id, label:'New validation check'});
  saveState();
  // Open it for editing immediately
  editingCheckIdx = state.validationChecksDef.length - 1;
  renderValidation();
  var input = document.getElementById('val-check-edit-input');
  if (input) { input.focus(); input.select(); }
}
function removeValidationCheck(idx) {
  if (!currentUser || currentUser.role !== 'admin') return;
  ensureValidationChecksDef();
  var chk = state.validationChecksDef[idx]; if (!chk) return;
  state.validationChecksDef.splice(idx, 1);
  // Clean up checked state for this check across all interfaces
  Object.keys(state.validationChecks).forEach(function(k) {
    if (k.endsWith('__' + chk.id)) delete state.validationChecks[k];
  });
  saveState(); renderValidation();
}
function moveValidationCheck(idx, dir) {
  if (!currentUser || currentUser.role !== 'admin') return;
  ensureValidationChecksDef();
  var newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= state.validationChecksDef.length) return;
  var temp = state.validationChecksDef[idx];
  state.validationChecksDef[idx] = state.validationChecksDef[newIdx];
  state.validationChecksDef[newIdx] = temp;
  saveState(); renderValidation();
}
function resetValidationChecks() {
  if (!currentUser || currentUser.role !== 'admin') return;
  state.validationChecksDef = DEFAULT_VALIDATION_CHECKS.map(function(c){return {id:c.id, label:c.label};});
  saveState(); renderValidation();
}
function toggleCheck(ifId, checkId) { var k = ifId + '__' + checkId; state.validationChecks[k]=!state.validationChecks[k]; saveState(); renderValidation(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// dIF TEMPLATES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function defaultTemplates() {
  return [
    {
      id:1, code:'TF000', name:'External Connections', ver:'2.0.1',
      short:'Reusable external system connection configurations (HTTP, SFTP, AMQP, etc.).',
      desc:'<b>Not an integration flow template</b> ‚Äî a shared library of pre-configured external connections used by all other templates.<ul><li>HTTP/HTTPS endpoints (basic auth, OAuth2, client cert)</li><li>SFTP connection parameters</li><li>AMQP / JMS connection factories</li><li>Must be deployed once per landscape and referenced by all TF00x iFlows</li><li>Version: 2.0.1 ‚Äî parameters externalized to properties, reusable across multiple iFlows</li></ul>',
      dir:'N/A', proc:'N/A', proto:'HTTPS / SFTP / AMQP / JMS'
    },
    {
      id:2, code:'TF001', name:'Async Basic with Retries', ver:'1.5.2',
      short:'Basic asynchronous 1-1 processing with built-in retry logic. Default template for most async interfaces.',
      desc:'<b>Default template for the majority of async integrations.</b> Use when the sender does not need an immediate synchronous response.<ul><li>1-to-1 message processing (one inbound ‚Üí one outbound call)</li><li>Configurable retry policy (number of retries, delay)</li><li>Dead letter queue handling for unrecoverable errors</li><li>dIF standard alerting &amp; monitoring keys included</li><li>QA checks built-in</li></ul><b>When to use:</b> Standard async fire-and-forget scenario where reliability is required but strict ordering is not.',
      dir:'One-Way', proc:'Async', proto:'HTTPS'
    },
    {
      id:3, code:'TF002', name:'Sync Basic', ver:'1.4.6',
      short:'Basic synchronous 1-1 processing. Use when the caller requires an immediate response.',
      desc:'<b>Use when the caller needs a synchronous response.</b><ul><li>1-to-1 request-reply pattern</li><li>Error returned directly to caller in response</li><li>Timeout configuration required</li><li>Lower throughput ‚Äî not suitable for high-volume scenarios</li><li>QA checks built-in</li></ul><b>When to use:</b> Real-time lookups, validations, or scenarios where the calling system must receive a response before continuing (e.g. price checks, stock queries, master data lookups).',
      dir:'Request-Reply', proc:'Sync', proto:'HTTPS'
    },
    {
      id:4, code:'TF003', name:'Message Router', ver:'2.0.1',
      short:'Async message router for 1-1 or 1-N fan-out processing to multiple targets.',
      desc:'<b>Use when a single inbound message must be routed to one or more targets</b> based on content or configuration.<ul><li>Supports 1-to-1 and 1-to-N routing</li><li>Content-based routing via routing conditions</li><li>Each route has independent retry and error handling</li><li>Offload conditions and retry logic externalized</li><li>JSON formatter utility included</li></ul><b>When to use:</b> Distribution scenarios ‚Äî e.g. one SAP event must be sent to multiple downstream systems (WMS, TMS, reporting). Also used when routing logic determines which single target to call.',
      dir:'One-Way', proc:'Async', proto:'HTTPS'
    },
    {
      id:5, code:'TF004', name:'Async with Staging', ver:'1.5.2',
      short:'Asynchronous scenario with staged processing and per-stage retry configuration.',
      desc:'<b>Use when processing must happen in multiple distinct stages</b>, each with its own retry and error handling.<ul><li>Multi-stage pipeline: receive ‚Üí stage 1 ‚Üí stage 2 ‚Üí ‚Ä¶ ‚Üí deliver</li><li>Independent retry configuration per stage</li><li>Staged persistence between steps (survives failures mid-process)</li><li>Suitable for complex transformation + enrichment + delivery chains</li><li>QA checks built-in</li></ul><b>When to use:</b> Interfaces with enrichment steps (e.g. fetch additional data from a second system mid-flow), or where different stages have different SLAs or retry needs.',
      dir:'One-Way', proc:'Async', proto:'HTTPS'
    },
    {
      id:6, code:'TF005', name:'Job Delta', ver:'1.4.8',
      short:'Scheduled job with delta processing ‚Äî only changed records since last run are processed.',
      desc:'<b>Use for scheduled batch extractions where only new/changed records should be processed.</b><ul><li>Delta watermark stored and updated per run</li><li>Scheduler-triggered (timer or external trigger)</li><li>Suitable for periodic synchronisation (hourly, daily)</li><li>Handles large datasets by processing only the delta</li></ul><b>When to use:</b> Regular synchronisation of master data or transactional data where full loads are too expensive ‚Äî e.g. daily customer sync, nightly material master update.',
      dir:'One-Way', proc:'Batch', proto:'HTTPS / RFC'
    },
    {
      id:7, code:'TF006', name:'Job Bulk Data with Individual Processing', ver:'1.5.2',
      short:'Bulk data processing job where each record is processed individually with retries.',
      desc:'<b>Use for bulk data loads where each record must be processed and retried independently.</b><ul><li>Bulk retrieval (e.g. full extract or large delta)</li><li>Split into individual messages for per-record processing</li><li>Per-record retry logic ‚Äî one failing record does not block others</li><li>Error isolation: failed records logged, successful ones committed</li><li>QA checks built-in</li></ul><b>When to use:</b> Initial load scenarios, large data migrations, or periodic full syncs where individual record failures must not abort the entire batch.',
      dir:'One-Way', proc:'Batch', proto:'HTTPS / RFC / SFTP'
    },
    {
      id:8, code:'TF007', name:'Async with Aggregation', ver:'1.5.2',
      short:'Asynchronous scenario that aggregates multiple inbound messages before processing.',
      desc:'<b>Use when multiple inbound messages must be collected and combined before further processing.</b><ul><li>Message aggregation based on correlation key and/or time window</li><li>Configurable completion condition (count, timeout, custom)</li><li>Retry capabilities after aggregation step</li><li>Suitable for collecting split messages back into a bulk payload</li><li>QA checks built-in</li></ul><b>When to use:</b> Scenarios where a source system sends individual records that need to be bundled (e.g. collect 100 order lines then send as one batch to target), or re-aggregation after a split.',
      dir:'One-Way', proc:'Async', proto:'HTTPS / JMS'
    },
    {
      id:9, code:'TF008.1', name:'Async EOIO (Exactly Once In Order)', ver:'1.6.2',
      short:'Asynchronous exactly-once in-order processing. If one message fails, no further messages are processed.',
      desc:'<b>Use when strict message ordering AND exactly-once delivery is required.</b><ul><li>EOIO guarantee: messages processed in strict order</li><li>If message N fails, messages N+1, N+2‚Ä¶ are blocked until N is resolved</li><li>Uses SAP Integration Suite queue for ordering</li><li>Suitable for scenarios where out-of-order processing causes data corruption</li><li>QA checks built-in</li></ul><b>When to use:</b> Sequential document processing where order matters ‚Äî e.g. create customer ‚Üí then create order for that customer. Financial postings where sequence is critical.',
      dir:'One-Way', proc:'Async', proto:'HTTPS / Queue'
    },
    {
      id:10, code:'TF008.2', name:'Async EOIO ‚Äì Queue Reader', ver:'1.2.0',
      short:'EOIO queue reader component. Reads messages from a JMS/AMQP queue in strict order.',
      desc:'<b>Companion to TF008.1</b> ‚Äî the queue consumer side of an EOIO pattern.<ul><li>Reads from JMS or AMQP queue in sequence</li><li>Processes messages exactly once and in order</li><li>Works in combination with TF008.1 (writer) or TF009.1/.2 (JMS variants)</li></ul><b>When to use:</b> When the EOIO sender (TF008.1) writes to a queue and a separate iFlow must consume and process those messages.',
      dir:'One-Way', proc:'Async', proto:'AMQP / Queue'
    },
    {
      id:11, code:'TF009.1', name:'Async EOIO ‚Äì JMS', ver:'1.1.2',
      short:'Asynchronous EOIO using JMS messaging. If one message fails, no further ones are processed.',
      desc:'<b>JMS-based variant of EOIO (TF008.1).</b><ul><li>Uses JMS broker for message persistence and ordering</li><li>EOIO guarantee via JMS queue</li><li>If 1 message fails, subsequent messages are held</li><li>Higher reliability than HTTP-based EOIO</li><li>QA checks built-in</li></ul><b>When to use:</b> Same as TF008.1 but in landscapes where JMS broker (e.g. SAP Message Broker) is available and preferred for reliability/ordering guarantees.',
      dir:'One-Way', proc:'Async', proto:'JMS'
    },
    {
      id:12, code:'TF009.2', name:'Async EOIO ‚Äì Queue Reader (JMS)', ver:'1.1.0',
      short:'JMS queue reader for EOIO processing. Asynchronous EOIO queue processor.',
      desc:'<b>Companion queue reader for TF009.1.</b><ul><li>Reads from JMS queue in strict order</li><li>Processes messages exactly once in order</li><li>Decoupled consumer ‚Äî can be scaled or redeployed independently</li></ul><b>When to use:</b> When TF009.1 writes to a JMS queue and a separate consumer iFlow is needed.',
      dir:'One-Way', proc:'Async', proto:'JMS'
    },
  ];
}
function openAddTemplate() {
  document.getElementById('tmpl-edit-id').value='';
  document.getElementById('tmpl-modal-id-display').textContent='';
  ['tmpl-code','tmpl-name','tmpl-short','tmpl-proto','tmpl-ver'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('tmpl-desc-rte').innerHTML='';
  document.getElementById('tmpl-delete-btn').style.display='none';
  openModal('addTemplate');
}
function editTemplate(id) {
  const t=state.difTemplates.find(x=>x.id===id); if(!t) return;
  document.getElementById('tmpl-edit-id').value=id;
  document.getElementById('tmpl-modal-id-display').textContent=t.code;
  document.getElementById('tmpl-code').value=t.code;
  document.getElementById('tmpl-name').value=t.name;
  document.getElementById('tmpl-ver').value=t.ver||'';
  document.getElementById('tmpl-short').value=t.short;
  document.getElementById('tmpl-desc-rte').innerHTML=t.desc||'';
  document.getElementById('tmpl-dir').value=t.dir;
  document.getElementById('tmpl-proc').value=t.proc;
  document.getElementById('tmpl-proto').value=t.proto||'';
  document.getElementById('tmpl-delete-btn').style.display='inline-flex';
  openModal('addTemplate');
}
function saveTemplate() {
  const editId=document.getElementById('tmpl-edit-id').value;
  const code=document.getElementById('tmpl-code').value.trim();
  const name=document.getElementById('tmpl-name').value.trim();
  var missing = [];
  if (!code) missing.push('tmpl-code');
  if (!name) missing.push('tmpl-name');
  if (missing.length) { highlightMissing(missing); return; }
  const data={code,name,ver:document.getElementById('tmpl-ver')?document.getElementById('tmpl-ver').value.trim():'',short:document.getElementById('tmpl-short').value.trim(),desc:document.getElementById('tmpl-desc-rte').innerHTML,dir:document.getElementById('tmpl-dir').value,proc:document.getElementById('tmpl-proc').value,proto:document.getElementById('tmpl-proto').value.trim()};
  if (editId) { const t=state.difTemplates.find(x=>String(x.id)===String(editId)); if(t) Object.assign(t,data); }
  else state.difTemplates.push({id:Date.now(),...data});
  saveState(); closeModal('addTemplate'); renderTemplates();
  toast(editId ? 'Template updated' : 'Template added', 'success');
}
function deleteTemplate() {
  var id=document.getElementById('tmpl-edit-id').value;
  if(!id) return;
  confirmDialog('Delete this template?<br><br>This cannot be undone.').then(function(ok){
    if(!ok) return;
    state.difTemplates=state.difTemplates.filter(function(t){return String(t.id)!==String(id);});
    saveState(); closeModal('addTemplate'); renderTemplates();
    toast('Template deleted', 'warning');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USER MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initPermGrid(gridId, roleSelId, initialRole) {
  const grid = document.getElementById(gridId);
  const perms = ROLE_DEFAULTS[initialRole] || ROLE_DEFAULTS.custom;
  grid.innerHTML = `
    <div class="perm-grid" style="margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid var(--border)">
      <span style="font-family:var(--mono);font-size:10px;color:var(--text-dim)">Section</span>
      <span class="perm-header">Read</span>
      <span class="perm-header">Write</span>
    </div>` +
    VIEW_PERMS.map(v => `
    <div class="perm-grid" style="margin-bottom:4px">
      <span class="perm-label">${v.label}</span>
      <span class="perm-check"><input type="checkbox" id="${gridId}-${v.id}-r" ${perms[v.id]&&perms[v.id].r?'checked':''}></span>
      <span class="perm-check"><input type="checkbox" id="${gridId}-${v.id}-w" ${perms[v.id]&&perms[v.id].w?'checked':''}></span>
    </div>`).join('');
}

function applyRoleDefaults(gridId, role) {
  const perms = ROLE_DEFAULTS[role] || ROLE_DEFAULTS.custom;
  VIEW_PERMS.forEach(v => {
    const r = document.getElementById(`${gridId}-${v.id}-r`); if(r) r.checked = !!(perms[v.id]&&perms[v.id].r);
    const w = document.getElementById(`${gridId}-${v.id}-w`); if(w) w.checked = !!(perms[v.id]&&perms[v.id].w);
  });
}

function readPermGrid(gridId) {
  const perms = {};
  VIEW_PERMS.forEach(v => {
    const r = document.getElementById(`${gridId}-${v.id}-r`);
    const w = document.getElementById(`${gridId}-${v.id}-w`);
    perms[v.id] = { r: r?r.checked:false, w: w?w.checked:false };
  });
  return perms;
}

function updatePermCheckboxes()   { applyRoleDefaults('permGrid',   document.getElementById('u-role').value); }
function updateARPermCheckboxes() { applyRoleDefaults('arPermGrid', document.getElementById('ar-role').value); }

function openAddUser(prefill) {
  document.getElementById('userModalTitle').textContent = 'Add User';
  document.getElementById('u-edit-id').value = '';
  document.getElementById('u-delete-btn').style.display = 'none';
  document.getElementById('u-name').value    = prefill?.name  || '';
  document.getElementById('u-email').value   = prefill?.email || '';
  const pwInput = document.getElementById('u-password');
  pwInput.value = '';
  pwInput.type  = 'password';
  document.getElementById('u-pw-eye').style.color = '';
  document.getElementById('u-pw-hint').style.display = 'none';
  document.getElementById('u-role').value    = 'developer';
  initPermGrid('permGrid','u-role','developer');
  openModal('addUser');
}

function editUser(id) {
  const u = state.users.find(x=>x.id===id); if(!u) return;
  document.getElementById('userModalTitle').textContent = 'Edit User';
  document.getElementById('u-edit-id').value  = id;
  document.getElementById('u-delete-btn').style.display = u.role==='admin'?'none':'inline-flex';
  document.getElementById('u-name').value     = u.name;
  document.getElementById('u-email').value    = u.email;
  // Password: hidden by default, admin can reveal with eye button
  var pwInput = document.getElementById('u-password');
  var knownPlain = plainPasswordStore[u.id];
  pwInput.value = knownPlain || '';
  pwInput.type  = 'password';
  document.getElementById('u-pw-eye').style.color = '';
  var hint = document.getElementById('u-pw-hint');
  hint.textContent = knownPlain
    ? 'Click üëÅ to reveal ‚Äî copy to share with user'
    : 'Password is hashed ‚Äî enter a new one to reset it';
  hint.style.display = 'block';
  document.getElementById('u-role').value     = u.role;
  initPermGrid('permGrid','u-role', u.role);
  if (u.perms) VIEW_PERMS.forEach(v => {
    const r=document.getElementById(`permGrid-${v.id}-r`); if(r) r.checked=!!(u.perms[v.id]&&u.perms[v.id].r);
    const w=document.getElementById(`permGrid-${v.id}-w`); if(w) w.checked=!!(u.perms[v.id]&&u.perms[v.id].w);
  });
  openModal('addUser');
}

function saveUser() {
  var editId  = document.getElementById('u-edit-id').value;
  var name    = document.getElementById('u-name').value.trim();
  var email   = document.getElementById('u-email').value.trim();
  var password= document.getElementById('u-password').value;
  var role    = document.getElementById('u-role').value;
  var missing = [];
  if (!name) missing.push('u-name');
  if (!email) missing.push('u-email');
  if (!editId && !password) missing.push('u-password');
  if (missing.length) { highlightMissing(missing); return; }
  var perms = readPermGrid('permGrid');
  function doSave(hashedPw) {
    if (editId) {
      var u=state.users.find(function(x){return String(x.id)===String(editId);}); if(!u) return;
      u.name=name; u.email=email; u.role=role; u.perms=perms;
      if(hashedPw) { plainPasswordStore[u.id]=password; u.password=hashedPw; }
      if(currentUser&&currentUser.id===u.id){ currentUser=u; document.getElementById('cuName').textContent=u.name; document.getElementById('cuRole').textContent=u.role; }
    } else {
      if(state.users.find(function(u){return u.email.toLowerCase()===email.toLowerCase();})){ toast('A user with this email already exists','error'); return; }
      if(!hashedPw){ toast('Please set a password for the new user','error'); return; }
      var newId=Date.now(); plainPasswordStore[newId]=password;
      state.users.push({id:newId,name:name,email:email,password:hashedPw,role:role,perms:perms,active:true,created:new Date().toISOString()});
    }
    saveState(); closeModal('addUser'); renderUsers();
    toast(editId ? 'User updated' : 'User created', 'success');
  }
  if (password) {
    sha256(password).then(doSave);
  } else {
    doSave(null);
  }
}

var plainPasswordStore = {};

function deleteUser() {
  var id = document.getElementById('u-edit-id').value;
  if(!id) return;
  var u=state.users.find(function(x){return String(x.id)===String(id);});
  confirmDialog('Remove user <b>'+(u?u.name:'')+'</b>?<br><br>They will lose access immediately.').then(function(ok){
    if(!ok) return;
    state.users = state.users.filter(function(x){return String(x.id)!==String(id);});
    saveState(); closeModal('addUser'); renderUsers();
    toast('User removed', 'warning');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACCESS REQUESTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openApproveRequest(reqId) {
  const req = state.accessRequests.find(r=>r.id===reqId); if(!req) return;
  document.getElementById('ar-req-id').value = reqId;
  document.getElementById('approveRequestInfo').innerHTML = `
    <div style="font-weight:600;font-size:14px">${req.name}</div>
    <div style="color:var(--text-muted);font-family:var(--mono);font-size:12px">${req.email}</div>
    ${req.company ? `<div style="margin-top:4px;font-size:12px">${req.company}</div>` : ''}
    ${req.reason  ? `<div style="margin-top:6px;font-size:12px;font-style:italic;color:var(--text-muted)">"${req.reason}"</div>` : ''}
    <div style="margin-top:4px;font-size:11px;color:var(--text-dim)">Requested ${req.created ? req.created.slice(0,10) : ''}</div>`;
  document.getElementById('ar-role').value = 'developer';
  document.getElementById('ar-password').value = '';
  initPermGrid('arPermGrid', 'ar-role', 'developer');
  openModal('approveRequest');
}

function approveRequest() {
  var reqId   = document.getElementById('ar-req-id').value;
  var req     = state.accessRequests.find(function(r){return r.id==reqId;}); if(!req) return;
  var password= document.getElementById('ar-password').value;
  var role    = document.getElementById('ar-role').value;
  if(!password){ toast('Please set a password for this user','error'); return; }
  var perms = readPermGrid('arPermGrid');
  sha256(password).then(function(hashed) {
    var newId=Date.now(); plainPasswordStore[newId]=password;
    state.users.push({id:newId,name:req.name,email:req.email,password:hashed,role:role,perms:perms,active:true,created:new Date().toISOString()});
    req.status = 'approved';
    saveState(); closeModal('approveRequest'); renderUsers(); updateReqNotification();
    toast('Access approved ‚Äî user can now sign in', 'success');
  });
}

function denyRequest(reqId) {
  confirmDialog('Deny and remove this access request?').then(function(ok){
    if(!ok) return;
    state.accessRequests = state.accessRequests.filter(function(r){return r.id!==reqId;});
    saveState(); renderUsers(); updateReqNotification();
    toast('Access request denied', 'warning');
  });
}

function updateReqNotification() {
  const count = state.accessRequests.filter(r=>r.status==='pending').length;
  ['nav-req-dot'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){ el.className=count>0?'notif-dot':'notif-dot hidden'; }
  });
  const rc=document.getElementById('reqCount'); if(rc) rc.textContent=count;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function statusBadge(s) { const m={spec:'badge-spec',dev:'badge-dev',review:'badge-review',done:'badge-done',parked:'badge-parked',blocked:'badge-blocked'}; return `<span class="badge ${m[s]||'badge-spec'}">${s}</span>`; }
function priorityBadge(p) { const m={high:'badge-high',medium:'badge-medium',low:'badge-low'}; return `<span class="badge ${m[p]||'badge-medium'}">${p}</span>`; }
function roleBadge(r) { const m={admin:'badge-admin',architect:'badge-architect',developer:'badge-developer',viewer:'badge-viewer',custom:'badge-viewer'}; return `<span class="badge ${m[r]||'badge-viewer'}">${r}</span>`; }
function avatarColor(name) { const c=['#4f9cf9','#3ddc84','#f5c842','#a78bfa','#fb923c','#f96060']; let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))%c.length; return c[h]; }

function getProjIf()  { return state.interfaces.filter(i=>i.projectId===state.activeProject); }
function getProjTL()  { return state.timeLogs.filter(t=>t.projectId===state.activeProject); }
function getProjOP()  { return state.openPoints.filter(o=>o.projectId===state.activeProject); }

function renderDashboard() {
  const ifaces=getProjIf(), logs=getProjTL(), ops=getProjOP();
  const totalH=logs.reduce((s,t)=>s+t.hours,0);
  const doneCount=(ifaces.filter(i=>i.status==='dev').length);
  const doneFull=(ifaces.filter(i=>i.status==='done').length);
  const pct=ifaces.length?Math.round(doneFull/ifaces.length*100):0;
  const openOPs=ops.filter(o=>o.status==='open').length;
  document.getElementById('statsRow').innerHTML=`
    <div class="stat-card"><div class="stat-label">Interfaces</div><div class="stat-value" data-target="${ifaces.length}" style="color:var(--accent)">0</div><div class="stat-sub">in this project</div></div>
    <div class="stat-card"><div class="stat-label">Done</div><div class="stat-value" data-target="${doneFull}" style="color:var(--green)">0</div><div class="stat-sub">${pct}% complete</div><div class="progress-bar" style="margin-top:8px"><div class="progress-fill green" style="width:${pct}%"></div></div></div>
    <div class="stat-card"><div class="stat-label">In Dev</div><div class="stat-value" data-target="${doneCount}" style="color:var(--yellow)">0</div><div class="stat-sub">${ifaces.filter(i=>i.status==='spec').length} in spec</div></div>
    <div class="stat-card"><div class="stat-label">Total Hours</div><div class="stat-value" data-target="${totalH.toFixed(1)}" style="color:var(--purple)">0</div><div class="stat-sub">${logs.length} entries</div></div>
    <div class="stat-card"><div class="stat-label">Open Points</div><div class="stat-value" data-target="${openOPs}" style="color:var(--orange)">0</div><div class="stat-sub">${ops.length-openOPs} resolved</div></div>`;
  animateCounters();
  renderDashboardChart();
  const tbody=ifaces.slice(0,8).map(i=>`<tr><td class="td-mono">${i.ifId||'‚Äî'}</td><td>${i.name}</td><td>${statusBadge(i.status)}</td></tr>`).join('');
  document.getElementById('dashIfTable').innerHTML=ifaces.length?`<table><thead><tr><th>ID</th><th>Name</th><th>Status</th></tr></thead><tbody>${tbody}</tbody></table>`:'<div class="empty-state"><div class="empty-icon">‚áÑ</div>No interfaces yet</div>';
  const recent=[...logs].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,5);
  document.getElementById('recentTime').innerHTML=recent.length?recent.map(t=>`<div class="time-entry"><span class="time-who">${t.person}</span><span class="time-hours" style="color:var(--accent)">${t.hours}h</span><span class="time-desc">${t.phase}</span><span class="time-date">${t.date}</span></div>`).join(''):'<div class="empty-state" style="padding:20px">No time logged yet</div>';
  const topOPs=ops.filter(o=>o.status==='open').slice(0,3);
  document.getElementById('dashOpenPoints').innerHTML=topOPs.length?topOPs.map(op=>`<div class="open-point"><div class="open-point-header"><span class="open-point-id">OP-${String(op.id).slice(-4)}</span><span class="open-point-owner">${op.owner||'Unassigned'}</span></div><div>${op.desc.replace(/<[^>]+>/g,' ').slice(0,120)}</div></div>`).join(''):'<div class="empty-state" style="padding:20px;text-align:left;color:var(--green)">‚úì No open points</div>';
}

function renderInterfaces() {
  var allIf=getProjIf(), logs=getProjTL();
  document.getElementById('tab-if-count').textContent=allIf.length;
  var rw = canWrite('interfaces');
  // Filters
  var fStatus = document.getElementById('flt-if-status').value;
  var fPriority = document.getElementById('flt-if-priority').value;
  var fSearch = (document.getElementById('flt-if-search').value||'').toLowerCase();
  var ifaces = allIf.filter(function(i){
    if(fStatus && i.status!==fStatus) return false;
    if(fPriority && i.priority!==fPriority) return false;
    if(fSearch && (i.ifId||'').toLowerCase().indexOf(fSearch)===-1 && (i.name||'').toLowerCase().indexOf(fSearch)===-1 && (i.source||'').toLowerCase().indexOf(fSearch)===-1 && (i.target||'').toLowerCase().indexOf(fSearch)===-1) return false;
    return true;
  });
  // Column sorting
  var pOrd={high:0,medium:1,low:2}; var sOrd={spec:0,dev:1,review:2,done:3,parked:4,blocked:5};
  ifaces = applySorting('if', ifaces, function(i, col) {
    if(col==='id') return i.ifId||'';
    if(col==='name') return i.name||'';
    if(col==='source') return i.source||'';
    if(col==='target') return i.target||'';
    if(col==='status') return sOrd[i.status]||0;
    if(col==='priority') return pOrd[i.priority]||1;
    if(col==='hours') return logs.filter(function(t){return String(t.interfaceId)===String(i.id);}).reduce(function(s,t){return s+t.hours;},0);
    return '';
  });
  updateSortHeaders('if');
  var tbody=ifaces.map(function(i){
    var hours=logs.filter(function(t){return String(t.interfaceId)===String(i.id);}).reduce(function(s,t){return s+t.hours;},0);
    var difTmpl=state.difTemplates.find(function(t){return t.code===i.dif;});
    var difLabel=difTmpl?(difTmpl.code+' ‚Äì '+difTmpl.name):(i.dif||'‚Äî');
    var isChecked=bulkSelected.interfaces.indexOf(i.id)!==-1;
    return '<tr draggable="true" ondragstart="dragStart(\'interfaces\','+i.id+',event)" ondragend="dragEnd(event)" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropOn(\'interfaces\','+i.id+',event)"><td><input type="checkbox" class="bulk-check" id="bulk-interfaces-'+i.id+'" '+(isChecked?'checked':'')+' onchange="toggleBulk(\'interfaces\','+i.id+')"/></td><td class="td-mono">'+(i.ifId||'‚Äî')+'</td><td style="max-width:160px">'+i.name+'</td><td class="td-muted">'+(i.source||'‚Äî')+'</td><td class="td-muted">'+(i.target||'‚Äî')+'</td><td><span class="tag">'+difLabel+'</span></td><td>'+(rw?'<select onchange="updateIfStatus('+i.id+',this.value)" style="padding:3px 6px;font-size:11px;background:var(--surface2)">'+['spec','dev','review','done','parked','blocked'].map(function(s){return '<option '+(i.status===s?'selected':'')+' value="'+s+'">'+s+'</option>';}).join('')+'</select>':statusBadge(i.status))+'</td><td>'+priorityBadge(i.priority)+'</td><td class="td-muted">'+(i.specAuthor||'‚Äî')+'</td><td class="td-muted">'+(i.dev||'‚Äî')+'</td><td class="td-mono">'+(hours>0?hours.toFixed(1)+'h':'‚Äî')+'</td><td>'+(rw?'<button class="btn btn-edit btn-sm" onclick="editInterface('+i.id+')" title="Edit">‚úé</button>':'')+(currentUser&&currentUser.role==='admin'?'<button class="btn btn-danger btn-sm" onclick="deleteIf('+i.id+')" title="Delete">‚úï</button>':'')+'</td></tr>';
  }).join('');
  updateBulkBar('interfaces');
  document.getElementById('ifTableBody').innerHTML=tbody||'<tr><td colspan="12" class="empty-state">No interfaces match filters.</td></tr>';
}

function renderTimeLog() {
  var allLogs=getProjTL(), ifaces=getProjIf();
  // Populate dynamic filter dropdowns
  var personSel=document.getElementById('flt-tl-person'), curPerson=personSel.value;
  var persons=[]; allLogs.forEach(function(t){if(t.person&&persons.indexOf(t.person)===-1) persons.push(t.person);});
  personSel.innerHTML='<option value="">All</option>'+persons.map(function(p){return '<option'+(curPerson===p?' selected':'')+'>'+p+'</option>';}).join('');
  var ifaceSel=document.getElementById('flt-tl-iface'), curIf=ifaceSel.value;
  ifaceSel.innerHTML='<option value="">All</option>'+ifaces.map(function(i){return '<option value="'+i.id+'"'+((curIf==String(i.id))?' selected':'')+'>'+(i.ifId||'?')+' ‚Äì '+i.name+'</option>';}).join('');
  // Stats on all (unfiltered)
  var totalH=allLogs.reduce(function(s,t){return s+t.hours;},0);
  var archH=allLogs.filter(function(t){return t.role==='Architect';}).reduce(function(s,t){return s+t.hours;},0);
  var devH=allLogs.filter(function(t){return t.role==='Developer';}).reduce(function(s,t){return s+t.hours;},0);
  var testH=allLogs.filter(function(t){return t.role==='Testing'||t.role==='Test Lead';}).reduce(function(s,t){return s+t.hours;},0);
  document.getElementById('timeStats').innerHTML='<div class="stat-card"><div class="stat-label">Total Hours</div><div class="stat-value" style="color:var(--accent)">'+totalH.toFixed(1)+'</div></div><div class="stat-card"><div class="stat-label">Architect</div><div class="stat-value" style="color:var(--purple)">'+archH.toFixed(1)+'</div></div><div class="stat-card"><div class="stat-label">Developer</div><div class="stat-value" style="color:var(--yellow)">'+devH.toFixed(1)+'</div></div><div class="stat-card"><div class="stat-label">Test</div><div class="stat-value" style="color:var(--green)">'+testH.toFixed(1)+'</div></div>';
  // Filters
  var fPerson=personSel.value, fRole=document.getElementById('flt-tl-role').value, fPhase=document.getElementById('flt-tl-phase').value, fIface=document.getElementById('flt-tl-iface').value;
  var logs=allLogs.filter(function(t){
    if(fPerson && t.person!==fPerson) return false;
    if(fRole && t.role!==fRole) return false;
    if(fPhase && t.phase!==fPhase) return false;
    if(fIface && String(t.interfaceId)!==fIface) return false;
    return true;
  });
  // Column sorting (default: date desc)
  if (sortState['tl']) {
    logs = applySorting('tl', logs, function(t, col) {
      if(col==='date') return t.date||'';
      if(col==='person') return t.person||'';
      if(col==='role') return t.role||'';
      if(col==='phase') return t.phase||'';
      if(col==='hours') return t.hours||0;
      return '';
    });
  } else {
    logs.sort(function(a,b){ return (b.date||'').localeCompare(a.date||''); });
  }
  updateSortHeaders('tl');
  var isAdmin=currentUser&&currentUser.role==='admin';
  var myName=currentUser?currentUser.name:'';
  var tbody=logs.map(function(t){ var ifc=ifaces.find(function(i){return String(i.id)===String(t.interfaceId);}); var canDel=isAdmin||t.person===myName; var isTlChecked=bulkSelected.timeLogs.indexOf(t.id)!==-1;
    return '<tr><td><input type="checkbox" class="bulk-check" id="bulk-timeLogs-'+t.id+'" '+(isTlChecked?'checked':'')+' onchange="toggleBulk(\'timeLogs\','+t.id+')"/></td><td class="td-mono">'+t.date+'</td><td style="color:var(--accent);font-weight:600">'+t.person+'</td><td><span class="tag">'+t.role+'</span></td><td class="td-muted">'+(ifc?(ifc.ifId||'')+' '+ifc.name:'‚Äî project ‚Äî')+'</td><td><span class="tag">'+t.phase+'</span></td><td class="td-mono">'+t.hours+'h</td><td class="td-muted" style="max-width:200px;overflow:hidden">'+(t.desc||'').replace(/<[^>]+>/g,' ').slice(0,80)+'</td><td>'+(canDel?'<button class="btn btn-danger btn-sm" onclick="deleteTime('+t.id+')" title="Delete">‚úï</button>':'')+'</td></tr>'; }).join('');
  updateBulkBar('timeLogs');
  document.getElementById('timeTableBody').innerHTML=tbody||'<tr><td colspan="9" class="empty-state">No time entries match filters.</td></tr>';
}

function exportTimeLog() {
  var allLogs=getProjTL(), ifaces=getProjIf();
  var proj=state.projects.find(function(p){return p.id===state.activeProject;});
  // Apply same filters as UI
  var fPerson=document.getElementById('flt-tl-person').value;
  var fRole=document.getElementById('flt-tl-role').value;
  var fPhase=document.getElementById('flt-tl-phase').value;
  var fIface=document.getElementById('flt-tl-iface').value;
  var logs=allLogs.filter(function(t){
    if(fPerson && t.person!==fPerson) return false;
    if(fRole && t.role!==fRole) return false;
    if(fPhase && t.phase!==fPhase) return false;
    if(fIface && String(t.interfaceId)!==fIface) return false;
    return true;
  });
  if (sortState['tl']) {
    logs = applySorting('tl', logs, function(t, col) {
      if(col==='date') return t.date||'';
      if(col==='person') return t.person||'';
      if(col==='role') return t.role||'';
      if(col==='phase') return t.phase||'';
      if(col==='hours') return t.hours||0;
      return '';
    });
  } else {
    logs.sort(function(a,b){ return (b.date||'').localeCompare(a.date||''); });
  }
  if(!logs.length){ toast('No time entries to export','warning'); return; }
  // Build CSV
  function csvEscape(val){
    var s=String(val||'').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
    if(s.indexOf(',')!==-1||s.indexOf('"')!==-1||s.indexOf('\n')!==-1) s='"'+s.replace(/"/g,'""')+'"';
    return s;
  }
  var headers=['Date','Person','Role','Interface ID','Interface Name','Phase','Hours','Description'];
  var rows=[headers.join(',')];
  logs.forEach(function(t){
    var ifc=ifaces.find(function(i){return String(i.id)===String(t.interfaceId);});
    rows.push([
      csvEscape(t.date),
      csvEscape(t.person),
      csvEscape(t.role),
      csvEscape(ifc?ifc.ifId:''),
      csvEscape(ifc?ifc.name:'Project level'),
      csvEscape(t.phase),
      t.hours,
      csvEscape(t.desc)
    ].join(','));
  });
  // Add totals row
  var totalH=logs.reduce(function(s,t){return s+t.hours;},0);
  rows.push('');
  rows.push(',,,,,Total,'+totalH.toFixed(1)+',');
  // Active filters summary
  var filters=[];
  if(fPerson) filters.push('Person: '+fPerson);
  if(fRole) filters.push('Role: '+fRole);
  if(fPhase) filters.push('Phase: '+fPhase);
  if(fIface){var fi=ifaces.find(function(i){return String(i.id)===fIface;}); filters.push('Interface: '+(fi?(fi.ifId||'')+' '+fi.name:''));}
  if(filters.length){rows.push(''); rows.push('Filters applied:,'+csvEscape(filters.join(' | ')));}
  // Download with UTF-8 BOM for Excel
  var csv='\uFEFF'+rows.join('\r\n');
  var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');
  a.href=url;
  var projName=proj?proj.code||proj.name:'export';
  var today=new Date().toISOString().slice(0,10);
  a.download='TimeLog_'+projName.replace(/[^a-zA-Z0-9]/g,'')+'_'+today+'.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function renderOpenPoints() {
  var allOps=getProjOP(), ifaces=getProjIf();
  document.getElementById('tab-op-count').textContent=allOps.filter(function(o){return o.status==='open';}).length;
  // Populate dynamic dropdowns
  var ownerSel=document.getElementById('flt-op-owner'), curOwner=ownerSel.value;
  var owners=[]; allOps.forEach(function(o){if(o.owner&&owners.indexOf(o.owner)===-1) owners.push(o.owner);});
  ownerSel.innerHTML='<option value="">All</option>'+owners.map(function(p){return '<option'+(curOwner===p?' selected':'')+'>'+p+'</option>';}).join('');
  var ifaceSel=document.getElementById('flt-op-iface'), curIf=ifaceSel.value;
  ifaceSel.innerHTML='<option value="">All</option>'+ifaces.map(function(i){return '<option value="'+i.id+'"'+((curIf==String(i.id))?' selected':'')+'>'+(i.ifId||'?')+' ‚Äì '+i.name+'</option>';}).join('');
  // Filters
  var fStatus=document.getElementById('flt-op-status').value;
  var fPriority=document.getElementById('flt-op-priority').value;
  var fOwner=ownerSel.value;
  var fIface=ifaceSel.value;
  var ops=allOps.filter(function(o){
    if(fStatus && o.status!==fStatus) return false;
    if(fPriority && o.priority!==fPriority) return false;
    if(fOwner && o.owner!==fOwner) return false;
    if(fIface && String(o.interfaceId)!==fIface) return false;
    return true;
  });
  var pOrd={high:0,medium:1,low:2};
  if (sortState['op']) {
    ops = applySorting('op', ops, function(o, col) {
      if(col==='priority') return pOrd[o.priority]||1;
      if(col==='created') return o.created||'';
      if(col==='due') return o.due||'9999';
      if(col==='owner') return o.owner||'';
      if(col==='status') return o.status==='open'?0:1;
      return '';
    });
  } else {
    ops.sort(function(a,b){ return (pOrd[a.priority]||1)-(pOrd[b.priority]||1); });
  }
  var rw=canWrite('openpoints');
  var isAdmin=currentUser&&currentUser.role==='admin';
  // Sort header bar for open points
  function opSortTh(col,label){var s=sortState['op']; var cls='sortable'+(s&&s.col===col?(s.dir==='asc'?' sort-asc':' sort-desc'):''); return '<th class="'+cls+'" onclick="colSort(\'op\',\''+col+'\')" style="padding:8px 12px">'+label+'</th>';}
  var opSortBar='<table style="width:100%;margin-bottom:8px"><thead><tr>'+opSortTh('priority','Priority')+opSortTh('status','Status')+opSortTh('owner','Owner')+opSortTh('due','Due Date')+opSortTh('created','Created')+'</tr></thead></table>';
  document.getElementById('opList').innerHTML=opSortBar+(ops.length?ops.map(function(op){ var ifc=ifaces.find(function(i){return String(i.id)===String(op.interfaceId);}); var res=op.status==='resolved'; return '<div class="open-point '+(res?'resolved':'')+'"><div class="open-point-header"><div style="display:flex;gap:8px;align-items:center"><span class="open-point-id">OP-'+String(op.id).slice(-4)+'</span>'+priorityBadge(op.priority)+(ifc?'<span class="tag">'+(ifc.ifId||ifc.name)+'</span>':'')+'</div><div style="display:flex;gap:6px;align-items:center"><span class="open-point-owner">'+(op.owner||'Unassigned')+'</span>'+(op.due?'<span class="td-muted" style="font-size:11px">'+op.due+'</span>':'')+(rw?'<button class="btn btn-edit btn-sm" onclick="editOpenPoint('+op.id+')" title="Edit">‚úé</button><button class="btn btn-success btn-sm" onclick="resolveOP('+op.id+')" title="'+(res?'Reopen':'Resolve')+'">'+(res?'‚Ü©':'‚úì')+'</button>':'')+(isAdmin?'<button class="btn btn-danger btn-sm" onclick="deleteOP('+op.id+')" title="Delete">‚úï</button>':'')+'</div></div><div style="margin-top:4px">'+op.desc+'</div></div>'; }).join(''):'<div class="empty-state"><div class="empty-icon">‚óé</div>No open points match filters</div>');
}

function renderValidation() {
  var CHECKS=getValidationChecks();
  var isAdmin=currentUser&&currentUser.role==='admin';
  var adminPanel='';
  if(isAdmin){
    adminPanel='<div class="table-wrap" style="padding:14px 16px;margin-bottom:20px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span class="section-title">Checklist Definition (Admin)</span><div style="display:flex;gap:6px"><button class="btn btn-primary btn-sm" onclick="addValidationCheck()">Ôºã Add Check</button><button class="btn btn-ghost btn-sm" onclick="resetValidationChecks()" title="Reset to defaults">‚Ü∫ Reset</button></div></div>';
    adminPanel+=CHECKS.map(function(c,idx){var isEditing=editingCheckIdx===idx; var labelHtml=isEditing?'<input id="val-check-edit-input" value="'+c.label.replace(/"/g,'&quot;')+'" style="flex:1;padding:4px 8px;font-size:13px;background:var(--surface2);border:1px solid var(--accent);color:var(--text);border-radius:4px;outline:none" onkeydown="if(event.key===\'Enter\')editValidationCheck('+idx+');if(event.key===\'Escape\')cancelEditCheck()"/>':'<span style="flex:1;font-size:13px">'+c.label+'</span>'; return '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)"><span class="td-mono" style="color:var(--text-dim);font-size:10px;width:24px;text-align:center">'+(idx+1)+'</span>'+labelHtml+'<button class="btn btn-ghost btn-sm" onclick="moveValidationCheck('+idx+',-1)" title="Move up" style="padding:2px 6px">‚ñ≤</button><button class="btn btn-ghost btn-sm" onclick="moveValidationCheck('+idx+',1)" title="Move down" style="padding:2px 6px">‚ñº</button><button class="btn btn-edit btn-sm" onclick="editValidationCheck('+idx+')" title="'+(isEditing?'Save':'Edit')+'">'+(isEditing?'‚úì':'‚úé')+'</button>'+(isEditing?'<button class="btn btn-ghost btn-sm" onclick="cancelEditCheck()" title="Cancel">‚úï</button>':'<button class="btn btn-danger btn-sm" onclick="removeValidationCheck('+idx+')" title="Remove">‚úï</button>')+'</div>';}).join('');
    adminPanel+='</div>';
  }
  var allIf=getProjIf();
  if(!allIf.length){ document.getElementById('validationContent').innerHTML=adminPanel+'<div class="empty-state"><div class="empty-icon">‚úì</div>Add interfaces to track validation</div>'; return; }
  var rw=canWrite('validation');
  var fStatus=document.getElementById('flt-val-status').value;
  var fSearch=(document.getElementById('flt-val-search').value||'').toLowerCase();
  var ifData=allIf.map(function(ifc){
    var dc=CHECKS.filter(function(c){return state.validationChecks[ifc.id+'__'+c.id];}).length;
    var pct=CHECKS.length?Math.round(dc/CHECKS.length*100):0;
    return {ifc:ifc, done:dc, pct:pct};
  });
  // Filter
  ifData=ifData.filter(function(d){
    if(fStatus==='complete' && d.pct!==100) return false;
    if(fStatus==='incomplete' && d.pct===100) return false;
    if(fSearch && (d.ifc.ifId||'').toLowerCase().indexOf(fSearch)===-1 && (d.ifc.name||'').toLowerCase().indexOf(fSearch)===-1) return false;
    return true;
  });
  // Column sorting
  if (sortState['val']) {
    ifData = applySorting('val', ifData, function(d, col) {
      if(col==='id') return d.ifc.ifId||'';
      if(col==='name') return d.ifc.name||'';
      if(col==='progress') return d.pct;
      return '';
    });
  }
  // Sort header bar
  function valSortTh(col,label){var s=sortState['val']; var cls='sortable'+(s&&s.col===col?(s.dir==='asc'?' sort-asc':' sort-desc'):''); return '<th class="'+cls+'" onclick="colSort(\'val\',\''+col+'\')" style="padding:8px 12px">'+label+'</th>';}
  var valSortBar='<table style="width:100%;margin-bottom:8px"><thead><tr>'+valSortTh('id','ID')+valSortTh('name','Name')+valSortTh('progress','Progress')+'</tr></thead></table>';
  document.getElementById('validationContent').innerHTML=adminPanel+valSortBar+ifData.map(function(d){ var ifc=d.ifc; var dc=d.done; var pct=d.pct; var checks=CHECKS.map(function(c){ var k=ifc.id+'__'+c.id; var done=!!state.validationChecks[k]; return '<div class="checklist-item"><div class="check-box '+(done?'checked':'')+'" '+(rw?'onclick="toggleCheck('+ifc.id+',\''+c.id+'\')"':'')+' style="'+(rw?'':'cursor:default')+'">'+(done?'‚úì':'')+'</div><span style="'+(done?'text-decoration:line-through;color:var(--text-dim)':'')+'">'+c.label+'</span></div>'; }).join(''); return '<div class="table-wrap" style="padding:14px 16px;margin-bottom:16px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div><span class="td-mono" style="color:var(--accent)">'+(ifc.ifId||'‚Äî')+'</span><span style="margin-left:8px;font-weight:600">'+ifc.name+'</span>'+statusBadge(ifc.status)+'</div><div style="display:flex;align-items:center;gap:8px"><span style="font-family:var(--mono);font-size:12px;color:var(--text-muted)">'+dc+'/'+CHECKS.length+'</span><div class="progress-bar" style="width:100px;margin:0"><div class="progress-fill '+(pct===100?'green':'')+'" style="width:'+pct+'%"></div></div></div></div>'+checks+'</div>'; }).join('')||'<div class="empty-state">No interfaces match filters</div>';
}

function renderTemplates() {
  const sel=document.getElementById('if-dif');
  if(sel) sel.innerHTML='<option value="">Select...</option>'+state.difTemplates.map(t=>`<option value="${t.code}">${t.code} ‚Äì ${t.name}</option>`).join('');
  const list=document.getElementById('templateList'); if(!list) return;
  list.innerHTML=state.difTemplates.map(t=>`<div class="template-card" onclick="editTemplate(${t.id})"><div class="template-card-header"><span class="template-code">${t.code}</span><span class="template-name">${t.name}</span>${t.ver?`<span class="tag" style="font-size:10px;color:var(--green)">v${t.ver}</span>`:''}<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();editTemplate(${t.id})">Edit</button></div><div class="template-desc">${t.short}</div>${t.desc?`<div class="template-desc" style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">${t.desc}</div>`:''}<div class="template-meta"><span class="tag">${t.dir}</span><span class="tag">${t.proc}</span>${t.proto?`<span class="tag">${t.proto}</span>`:''}</div></div>`).join('')||'<div class="empty-state"><div class="empty-icon">‚äû</div>No templates</div>';
}

function renderUsers() {
  updateReqNotification();
  // Access requests
  const pending=state.accessRequests.filter(r=>r.status==='pending');
  document.getElementById('requestList').innerHTML=pending.length?pending.map(r=>`<div class="request-card"><div class="request-header"><div class="request-info"><div class="request-name">${r.name}</div><div class="request-email">${r.email}</div>${r.company?`<div class="request-msg">${r.company}</div>`:''} ${r.reason?`<div class="request-msg">"${r.reason}"</div>`:''}<div class="request-date">${r.created?r.created.slice(0,10):''}</div></div><div class="request-actions"><button class="btn btn-success btn-sm" onclick="openApproveRequest(${r.id})">‚úì Approve</button><button class="btn btn-danger btn-sm" onclick="denyRequest(${r.id})">‚úï Deny</button></div></div></div>`).join(''):'<div class="empty-state" style="padding:30px"><div class="empty-icon">‚úì</div>No pending requests</div>';
  // Users
  const users=state.users;
  document.getElementById('userList').innerHTML=users.map(u=>{ const initials=u.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase(); const col=avatarColor(u.name); return `<div class="user-card"><div class="user-avatar" style="background:${col}30;color:${col}">${initials}</div><div class="user-info"><div class="user-name">${u.name}</div><div class="user-email">${u.email}</div><div class="user-meta">${roleBadge(u.role)}</div></div><div class="user-actions"><button class="btn btn-ghost btn-sm" onclick="editUser(${u.id})">Edit</button></div></div>`; }).join('')||'<div class="empty-state">No users</div>';
}

function renderAll() {
  if (!currentUser) return;
  renderDashboard();
  renderInterfaces();
  renderTimeLog();
  renderOpenPoints();
  renderValidation();
  renderProjectList();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyHL(color) { document.execCommand('hiliteColor',false,color); }
function removeHL() { document.execCommand('hiliteColor',false,'transparent'); document.execCommand('backColor',false,'transparent'); }

function openModal(name) {
  if(name==='logTime'){ populateIfDropdown('tl-interface'); document.getElementById('tl-date').value=new Date().toISOString().slice(0,10); if(currentUser) document.getElementById('tl-person').value=currentUser.name; }
  if(name==='addOpenPoint'){ populateIfDropdown('op-interface'); document.getElementById('modal-addOpenPoint').dataset.editId=''; document.getElementById('op-desc-rte').innerHTML=''; document.getElementById('op-owner').value=''; document.getElementById('op-due').value=''; document.getElementById('op-priority').value='medium'; document.getElementById('op-interface').value=''; }
  if(name==='addInterface'){ document.getElementById('modal-addInterface').dataset.editId=''; var sel=document.getElementById('if-dif'); sel.innerHTML='<option value="">Select...</option>'+state.difTemplates.map(function(t){return '<option value="'+t.code+'">'+t.code+' ‚Äì '+t.name+'</option>';}).join(''); ['if-id','if-name','if-source','if-target','if-spec-author','if-dev'].forEach(function(id){document.getElementById(id).value='';}); document.getElementById('if-notes-rte').innerHTML=''; document.getElementById('if-status').value='spec'; document.getElementById('if-priority').value='medium'; }
  var el=document.getElementById('modal-'+name);
  el.classList.remove('hidden');
  void el.offsetWidth;
  el.classList.add('modal-visible');
  setTimeout(function(){initMentions();initInputAutocomplete();}, 50);
}
function closeModal(name) {
  var el=document.getElementById('modal-'+name);
  el.classList.remove('modal-visible');
  setTimeout(function(){ el.classList.add('hidden'); }, 180);
}

document.querySelectorAll('.modal-overlay').forEach(function(el){
  el.addEventListener('click',function(e){ if(e.target===el){ el.classList.remove('modal-visible'); setTimeout(function(){ el.classList.add('hidden'); }, 180); } });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// @MENTION SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var mentionState = {active:false, query:'', startOffset:0, startNode:null, rteEl:null, selectedIdx:0};

function initMentions() {
  document.querySelectorAll('.rte-content').forEach(function(el) {
    if (el.dataset.mentionInit) return;
    el.dataset.mentionInit = '1';
    el.addEventListener('input', function(){ handleMentionInput(el); });
    el.addEventListener('keydown', function(e){ handleMentionKeydown(e, el); });
    el.addEventListener('blur', function(){ setTimeout(closeMentionDropdown, 200); });
  });
}

function handleMentionInput(el) {
  var sel = window.getSelection();
  if (!sel.rangeCount) { closeMentionDropdown(); return; }
  var range = sel.getRangeAt(0);
  var textNode = range.startContainer;
  if (textNode.nodeType !== 3) { closeMentionDropdown(); return; }
  var text = textNode.textContent;
  var cursor = range.startOffset;
  // Find @ before cursor
  var atIdx = -1;
  for (var i = cursor - 1; i >= 0; i--) {
    if (text[i] === '@') { atIdx = i; break; }
    if (text[i] === ' ' || text[i] === '\n') break;
  }
  if (atIdx === -1) { closeMentionDropdown(); return; }
  var query = text.substring(atIdx + 1, cursor).toLowerCase();
  mentionState = {active:true, query:query, startOffset:atIdx, startNode:textNode, rteEl:el, selectedIdx:0};
  showMentionDropdown(query, el);
}

function showMentionDropdown(query, el) {
  var users = state.users.filter(function(u) {
    return u.active !== false && ((u.name||'').toLowerCase().indexOf(query) !== -1 || (u.email||'').toLowerCase().indexOf(query) !== -1);
  });
  var dd = document.getElementById('mentionDropdown');
  if (!users.length) { dd.classList.add('hidden'); return; }
  dd.innerHTML = users.slice(0, 8).map(function(u, idx) {
    var initials = u.name.split(' ').map(function(w){return w[0];}).join('').slice(0,2).toUpperCase();
    var col = avatarColor(u.name);
    return '<div class="mention-item'+(idx===mentionState.selectedIdx?' active':'')+'" onmousedown="event.preventDefault();insertMention('+u.id+')">'
      +'<div class="mention-item-avatar" style="background:'+col+'30;color:'+col+'">'+initials+'</div>'
      +'<div><div class="mention-item-name">'+u.name+'</div><div class="mention-item-role">'+u.role+'</div></div></div>';
  }).join('');
  // Position near caret
  var sel = window.getSelection();
  if (sel.rangeCount) {
    var rect = sel.getRangeAt(0).getBoundingClientRect();
    dd.style.left = rect.left + 'px';
    dd.style.top = (rect.bottom + 4) + 'px';
  }
  dd.classList.remove('hidden');
}

function handleMentionKeydown(e, el) {
  if (!mentionState.active) return;
  var dd = document.getElementById('mentionDropdown');
  var items = dd.querySelectorAll('.mention-item');
  if (!items.length) return;
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    mentionState.selectedIdx = Math.min(mentionState.selectedIdx + 1, items.length - 1);
    items.forEach(function(it,i){it.classList.toggle('active',i===mentionState.selectedIdx);});
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    mentionState.selectedIdx = Math.max(mentionState.selectedIdx - 1, 0);
    items.forEach(function(it,i){it.classList.toggle('active',i===mentionState.selectedIdx);});
  } else if (e.key === 'Enter' && mentionState.active) {
    e.preventDefault();
    var activeItem = items[mentionState.selectedIdx];
    if (activeItem) activeItem.dispatchEvent(new Event('mousedown'));
  } else if (e.key === 'Escape') {
    closeMentionDropdown();
  }
}

function insertMention(userId) {
  var user = state.users.find(function(u){return u.id===userId;});
  if (!user || !mentionState.active) return;
  var textNode = mentionState.startNode;
  var text = textNode.textContent;
  var before = text.substring(0, mentionState.startOffset);
  var after = text.substring(mentionState.startOffset + mentionState.query.length + 1); // +1 for @
  // Create mention span
  var mentionSpan = document.createElement('span');
  mentionSpan.className = 'mention-tag';
  mentionSpan.contentEditable = 'false';
  mentionSpan.textContent = '@' + user.name;
  mentionSpan.dataset.userId = user.id;
  // Split text node and insert mention
  textNode.textContent = before;
  var afterNode = document.createTextNode('\u00A0' + after); // non-breaking space after mention
  var parent = textNode.parentNode;
  parent.insertBefore(mentionSpan, textNode.nextSibling);
  parent.insertBefore(afterNode, mentionSpan.nextSibling);
  // Place cursor after mention
  var sel = window.getSelection();
  var range = document.createRange();
  range.setStart(afterNode, 1);
  range.collapse(true);
  sel.removeAllRanges();
  sel.addRange(range);
  closeMentionDropdown();
}

function closeMentionDropdown() {
  mentionState.active = false;
  document.getElementById('mentionDropdown').classList.add('hidden');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INPUT USER AUTOCOMPLETE (for plain text inputs)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var inputACState = {el:null, selectedIdx:0};

function initInputAutocomplete() {
  document.querySelectorAll('input[data-user-autocomplete]').forEach(function(el) {
    if (el.dataset.acInit) return;
    el.dataset.acInit = '1';
    el.addEventListener('input', function(){ handleInputAC(el); });
    el.addEventListener('keydown', function(e){ handleInputACKey(e, el); });
    el.addEventListener('blur', function(){ setTimeout(closeInputAC, 200); });
    el.addEventListener('focus', function(){ handleInputAC(el); });
  });
}

function handleInputAC(el) {
  var val = el.value.trim().toLowerCase();
  if (!val) { closeInputAC(); return; }
  var users = state.users.filter(function(u) {
    return u.active !== false && ((u.name||'').toLowerCase().indexOf(val) !== -1 || (u.email||'').toLowerCase().indexOf(val) !== -1);
  });
  if (!users.length) { closeInputAC(); return; }
  inputACState = {el:el, selectedIdx:0};
  var dd = document.getElementById('inputAutocomplete');
  dd.innerHTML = users.slice(0, 6).map(function(u, idx) {
    var initials = u.name.split(' ').map(function(w){return w[0];}).join('').slice(0,2).toUpperCase();
    var col = avatarColor(u.name);
    return '<div class="mention-item'+(idx===0?' active':'')+'" onmousedown="event.preventDefault();selectInputAC(\''+u.name.replace(/'/g,"\\'")+'\')">'
      +'<div class="mention-item-avatar" style="background:'+col+'30;color:'+col+'">'+initials+'</div>'
      +'<div><div class="mention-item-name">'+u.name+'</div><div class="mention-item-role">'+u.role+'</div></div></div>';
  }).join('');
  var rect = el.getBoundingClientRect();
  dd.style.left = rect.left + 'px';
  dd.style.top = (rect.bottom + 4) + 'px';
  dd.style.width = rect.width + 'px';
  dd.classList.remove('hidden');
}

function handleInputACKey(e, el) {
  var dd = document.getElementById('inputAutocomplete');
  if (dd.classList.contains('hidden')) return;
  var items = dd.querySelectorAll('.mention-item');
  if (!items.length) return;
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    inputACState.selectedIdx = Math.min(inputACState.selectedIdx + 1, items.length - 1);
    items.forEach(function(it,i){it.classList.toggle('active',i===inputACState.selectedIdx);});
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    inputACState.selectedIdx = Math.max(inputACState.selectedIdx - 1, 0);
    items.forEach(function(it,i){it.classList.toggle('active',i===inputACState.selectedIdx);});
  } else if (e.key === 'Enter') {
    var activeItem = items[inputACState.selectedIdx];
    if (activeItem) { e.preventDefault(); activeItem.dispatchEvent(new Event('mousedown')); }
  } else if (e.key === 'Escape') {
    closeInputAC();
  }
}

function selectInputAC(name) {
  if (inputACState.el) inputACState.el.value = name;
  closeInputAC();
}

function closeInputAC() {
  document.getElementById('inputAutocomplete').classList.add('hidden');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBAL SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doGlobalSearch(q) {
  var box = document.getElementById('globalSearchResults');
  if (!q || q.length < 2) { box.classList.add('hidden'); box.innerHTML=''; return; }
  q = q.toLowerCase();
  var results = [];
  state.interfaces.forEach(function(i) {
    var proj = state.projects.find(function(p){return p.id===i.projectId;});
    if ((i.ifId||'').toLowerCase().indexOf(q)!==-1 || (i.name||'').toLowerCase().indexOf(q)!==-1 || (i.source||'').toLowerCase().indexOf(q)!==-1 || (i.target||'').toLowerCase().indexOf(q)!==-1)
      results.push({type:'Interface', label:(i.ifId||'')+' ‚Äì '+i.name, proj:proj?proj.name:'', pid:i.projectId, view:'interfaces'});
  });
  state.openPoints.forEach(function(o) {
    var proj = state.projects.find(function(p){return p.id===o.projectId;});
    if ((o.desc||'').toLowerCase().indexOf(q)!==-1 || (o.owner||'').toLowerCase().indexOf(q)!==-1)
      results.push({type:'Open Point', label:'OP-'+String(o.id).slice(-4)+' '+(o.desc||'').replace(/<[^>]+>/g,'').slice(0,40), proj:proj?proj.name:'', pid:o.projectId, view:'openpoints'});
  });
  state.timeLogs.forEach(function(t) {
    var proj = state.projects.find(function(p){return p.id===t.projectId;});
    if ((t.person||'').toLowerCase().indexOf(q)!==-1 || (t.desc||'').toLowerCase().indexOf(q)!==-1 || (t.phase||'').toLowerCase().indexOf(q)!==-1)
      results.push({type:'Time', label:t.date+' '+t.person+' '+t.hours+'h', proj:proj?proj.name:'', pid:t.projectId, view:'timelog'});
  });
  if (!results.length) { box.innerHTML='<div style="padding:8px;color:var(--text-dim)">No results</div>'; box.classList.remove('hidden'); return; }
  box.innerHTML = results.slice(0,10).map(function(r){
    return '<div style="padding:5px 4px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;gap:6px;align-items:center" onclick="selectProject('+r.pid+');setView(\''+r.view+'\');document.getElementById(\'globalSearch\').value=\'\';document.getElementById(\'globalSearchResults\').classList.add(\'hidden\')">'
      +'<span class="tag" style="font-size:9px">'+r.type+'</span>'
      +'<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+r.label+'</span>'
      +'<span style="color:var(--text-dim);font-size:10px">'+r.proj+'</span></div>';
  }).join('') + (results.length > 10 ? '<div style="padding:4px;color:var(--text-dim);text-align:center">+' + (results.length-10) + ' more</div>' : '');
  box.classList.remove('hidden');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BULK ACTIONS (select + delete)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var bulkSelected = {interfaces:[], timeLogs:[], openPoints:[]};

function toggleBulk(type, id) {
  var idx = bulkSelected[type].indexOf(id);
  if (idx === -1) bulkSelected[type].push(id); else bulkSelected[type].splice(idx, 1);
  updateBulkBar(type);
  // Toggle checkbox visual
  var cb = document.getElementById('bulk-'+type+'-'+id);
  if (cb) cb.checked = idx === -1;
}
function toggleBulkAll(type) {
  var items = [];
  if (type==='interfaces') items = getProjIf();
  else if (type==='timeLogs') items = getProjTL();
  else if (type==='openPoints') items = getProjOP();
  if (bulkSelected[type].length === items.length) bulkSelected[type] = [];
  else bulkSelected[type] = items.map(function(i){return i.id;});
  if (type==='interfaces') renderInterfaces();
  else if (type==='timeLogs') renderTimeLog();
  else if (type==='openPoints') renderOpenPoints();
  updateBulkBar(type);
}
function updateBulkBar(type) {
  var bar = document.getElementById('bulkBar-'+type);
  if (!bar) return;
  var count = bulkSelected[type].length;
  bar.style.display = count > 0 ? 'flex' : 'none';
  var countEl = bar.querySelector('.bulk-count');
  if (countEl) countEl.textContent = count + ' selected';
}
function bulkDelete(type) {
  var count = bulkSelected[type].length;
  if (!count) return;
  var label = type==='interfaces'?'interface(s)':type==='timeLogs'?'time entry(ies)':'open point(s)';
  confirmDialog('Delete <b>'+count+'</b> '+label+'?<br><br>This cannot be undone.').then(function(ok){
    if (!ok) return;
    var ids = bulkSelected[type].slice();
    var removed = [];
    if (type==='interfaces') { removed=state.interfaces.filter(function(i){return ids.indexOf(i.id)!==-1;}); state.interfaces=state.interfaces.filter(function(i){return ids.indexOf(i.id)===-1;}); }
    else if (type==='timeLogs') { removed=state.timeLogs.filter(function(t){return ids.indexOf(t.id)!==-1;}); state.timeLogs=state.timeLogs.filter(function(t){return ids.indexOf(t.id)===-1;}); }
    else if (type==='openPoints') { removed=state.openPoints.filter(function(o){return ids.indexOf(o.id)!==-1;}); state.openPoints=state.openPoints.filter(function(o){return ids.indexOf(o.id)===-1;}); }
    bulkSelected[type] = [];
    saveState(); renderAll();
    pushUndo(count+' '+label+' deleted', function(){
      if(type==='interfaces') removed.forEach(function(r){state.interfaces.push(r);});
      else if(type==='timeLogs') removed.forEach(function(r){state.timeLogs.push(r);});
      else if(type==='openPoints') removed.forEach(function(r){state.openPoints.push(r);});
      saveState(); renderAll();
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAG & DROP PRIORITY REORDER (interfaces & open points)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var dragState = {type:null, id:null};
function dragStart(type, id, ev) {
  dragState = {type:type, id:id};
  ev.dataTransfer.effectAllowed = 'move';
  ev.target.style.opacity = '0.5';
}
function dragEnd(ev) { ev.target.style.opacity = '1'; }
function dragOver(ev) { ev.preventDefault(); ev.dataTransfer.dropEffect = 'move'; ev.currentTarget.style.borderTop = '2px solid var(--accent)'; }
function dragLeave(ev) { ev.currentTarget.style.borderTop = ''; }
function dropOn(type, targetId, ev) {
  ev.preventDefault();
  ev.currentTarget.style.borderTop = '';
  if (dragState.type !== type || dragState.id === targetId) return;
  var arr = type === 'interfaces' ? state.interfaces : state.openPoints;
  var fromIdx = arr.findIndex(function(x){return x.id===dragState.id;});
  var toIdx = arr.findIndex(function(x){return x.id===targetId;});
  if (fromIdx===-1||toIdx===-1) return;
  var item = arr.splice(fromIdx, 1)[0];
  arr.splice(toIdx, 0, item);
  saveState(); renderAll();
  toast('Reordered', 'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD CHARTS (hours per person bar chart)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboardChart() {
  var container = document.getElementById('dashChart');
  if (!container) return;
  var logs = getProjTL();
  if (!logs.length) { container.innerHTML = '<div class="empty-state" style="padding:20px">No time data to chart</div>'; return; }
  // Hours per person
  var byPerson = {};
  logs.forEach(function(t) {
    byPerson[t.person] = (byPerson[t.person]||0) + t.hours;
  });
  var people = Object.keys(byPerson).sort(function(a,b){return byPerson[b]-byPerson[a];});
  var maxH = Math.max.apply(null, people.map(function(p){return byPerson[p];}));
  var bars = people.map(function(p) {
    var pct = maxH > 0 ? (byPerson[p]/maxH*100) : 0;
    var col = avatarColor(p);
    return '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">'
      +'<span style="width:80px;font-size:11px;font-family:var(--mono);color:var(--text-muted);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+p.split(' ')[0]+'</span>'
      +'<div style="flex:1;height:18px;background:var(--surface2);border-radius:3px;overflow:hidden">'
      +'<div style="width:'+pct+'%;height:100%;background:'+col+';border-radius:3px;transition:width .4s ease"></div></div>'
      +'<span style="width:40px;font-size:11px;font-family:var(--mono);font-weight:600">'+byPerson[p].toFixed(1)+'h</span></div>';
  }).join('');
  container.innerHTML = '<div class="section-header"><span class="section-title">Hours per Person</span></div>' + bars;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT PROJECT SUMMARY (CSV report)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportProjectSummary() {
  var proj = state.projects.find(function(p){return p.id===state.activeProject;});
  if (!proj) { toast('Select a project first', 'error'); return; }
  var ifaces = getProjIf(), logs = getProjTL(), ops = getProjOP();
  var bom = '\uFEFF';
  var rows = [];
  // Header
  rows.push('PROJECT SUMMARY REPORT');
  rows.push('Project,' + proj.name);
  rows.push('Code,' + (proj.code||''));
  rows.push('Landscape,' + (proj.landscape||''));
  rows.push('Phase,' + (proj.phase||''));
  rows.push('Generated,' + new Date().toISOString().slice(0,10));
  rows.push('');
  // Stats
  var totalH = logs.reduce(function(s,t){return s+t.hours;},0);
  var doneCount = ifaces.filter(function(i){return i.status==='done';}).length;
  rows.push('SUMMARY');
  rows.push('Total Interfaces,' + ifaces.length);
  rows.push('Completed,' + doneCount);
  rows.push('Total Hours,' + totalH.toFixed(1));
  rows.push('Open Points,' + ops.filter(function(o){return o.status==='open';}).length);
  rows.push('');
  // Interfaces
  rows.push('INTERFACES');
  rows.push('ID,Name,Source,Target,Template,Status,Priority,Spec Author,Developer,Hours');
  ifaces.forEach(function(i) {
    var hours = logs.filter(function(t){return String(t.interfaceId)===String(i.id);}).reduce(function(s,t){return s+t.hours;},0);
    var tmpl = state.difTemplates.find(function(t){return t.code===i.dif;});
    rows.push([i.ifId,i.name,i.source,i.target,tmpl?(tmpl.code+' '+tmpl.name):(i.dif||''),i.status,i.priority,i.specAuthor,i.dev,hours.toFixed(1)].map(function(v){v=String(v||'');return v.indexOf(',')!==-1?'"'+v+'"':v;}).join(','));
  });
  rows.push('');
  // Time Log
  rows.push('TIME LOG');
  rows.push('Date,Person,Role,Interface,Phase,Hours,Description');
  logs.forEach(function(t) {
    var ifc = ifaces.find(function(i){return String(i.id)===String(t.interfaceId);});
    rows.push([t.date,t.person,t.role,ifc?(ifc.ifId||''):'',t.phase,t.hours,(t.desc||'').replace(/<[^>]+>/g,' ').slice(0,100)].map(function(v){v=String(v||'');return v.indexOf(',')!==-1?'"'+v+'"':v;}).join(','));
  });
  rows.push('');
  // Open Points
  rows.push('OPEN POINTS');
  rows.push('ID,Interface,Priority,Status,Owner,Due Date,Description');
  ops.forEach(function(o) {
    var ifc = ifaces.find(function(i){return String(i.id)===String(o.interfaceId);});
    rows.push(['OP-'+String(o.id).slice(-4),ifc?(ifc.ifId||''):'',o.priority,o.status,o.owner,o.due,(o.desc||'').replace(/<[^>]+>/g,' ').slice(0,100)].map(function(v){v=String(v||'');return v.indexOf(',')!==-1?'"'+v+'"':v;}).join(','));
  });
  var csv = bom + rows.join('\r\n');
  var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'ProjectSummary_' + (proj.code||proj.name).replace(/[^a-zA-Z0-9]/g,'') + '_' + new Date().toISOString().slice(0,10) + '.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('Project summary exported', 'success');
}

// SIDEBAR COLLAPSE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleSidebar() {
  const sb = document.querySelector('.sidebar');
  sb.classList.toggle('collapsed');
  try { localStorage.setItem('dif-sidebar-collapsed', sb.classList.contains('collapsed')?'1':'0'); } catch(e){}
}
function restoreSidebarState() {
  try {
    const v = localStorage.getItem('dif-sidebar-collapsed');
    if (v === '1') document.querySelector('.sidebar').classList.add('collapsed');
    // On mobile, auto-collapse
    if (window.innerWidth <= 768) document.querySelector('.sidebar').classList.add('collapsed');
  } catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
restoreSidebarState();
loadState().then(function() {
  document.querySelectorAll('.color-opt').forEach(function(el) {
    el.addEventListener('click', function() {
      document.querySelectorAll('.color-opt').forEach(function(e) { e.classList.remove('selected'); });
      el.classList.add('selected');
      selectedColor = el.dataset.color;
    });
  });

  var saved = loadCurrent();
  if (saved) {
    currentUser = saved;
    bootApp();
  } else {
    document.getElementById('loginOverlay').classList.remove('hidden');
    document.getElementById('mainApp').style.display = 'none';
  }
});
</script>
</body>
</html>
